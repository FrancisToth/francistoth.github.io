<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Functional Design | Francis Toth / Contramap</title>

<meta name="keywords" content="" />
<meta name="description" content="This is a long due post following the talks given recently at Dawscon, CodeMesh, and Scala Toronto about Functional Design (slides are available here).
 Considering the amount of material available today, Software Design is rather intimidating. When it comes to best practices, one can get overwhelmed quickly and end up with no idea about how to tackle a given problem. Indeed, these guidelines can be vague, or too specific, if not contradictory sometime.">
<meta name="author" content="">
<link rel="canonical" href="https://contramap.dev/posts/2021-01-22-functional_design/" />
<link href="https://contramap.dev/assets/css/stylesheet.min.d1bc2b736056bd5698d770eeedc08a73bce9e6cebb30810f6f1b2c2048e46ab8.css" integrity="sha256-0bwrc2BWvVaY13Du7cCKc7zp5s67MIEPbxssIEjkarg=" rel="preload stylesheet"
    as="style">

<link rel="icon" href="https://contramap.dev/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://contramap.dev/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://contramap.dev/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://contramap.dev/apple-touch-icon.png">
<link rel="mask-icon" href="https://contramap.dev/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<meta name="generator" content="Hugo 0.74.3" />


<style>

    .dark {
        --hljs-bg: rgb(30, 40, 45);
    }
    .post-content .highlight,
    .post-content pre {
        margin-left: 0;
        margin-right: 0;
        background: var(--hljs-bg) !important;
        border-radius: var(--radius);
        background-color: rgb(30, 40, 45) !important;
    }
    .post-content p {
        text-align: justify;
        text-justify: inter-word;
    }

    .btn {
        -webkit-border-radius: 5;
        -moz-border-radius: 5;
        border-radius: 5px;
        font-family: Arial;
        color: #ffffff;
        font-size: 13px;
        padding: 2px 7px 2px 7px;
        text-decoration: none;
    }

     

    
    .grey0 {
        background: #8a8a8a;
    }
    
    .white0 {
        background: #68899e;
    }

    .dark {
    --hljs-bg: #263238;
    }

    .post-content code {
        font-family: Hack, monospace !important;
    }

    .first-entry {
        position: relative;
        display: flex;
        flex-direction: column;
        justify-content: center;
        min-height: 0px;
        margin: var(--gap) 0 calc(var(--gap) * 2) 0;
        margin-bottom: 0;
    }

.highlight .hll { background-color: #ffffcc }
.highlight  { background: rgb(30, 40, 45); }
.highlight .c { color: #546E7A; font-style: italic }  
.highlight .err { color: #a61717; background-color: #e3d2d2 }  
.highlight .k { color:rgb(194, 136, 232);  }  
.hljs-keyword { color:rgb(194, 136, 232);  }  

.highlight .ch { color: #546E7A; font-style: italic }  
.highlight .cm { color: rgb(167, 159, 148); font-style: italic }  
.highlight .cp { color: #546E7A }  
.highlight .cpf { color: #546E7A; font-style: italic }  
.highlight .c1 { color: rgb(167, 159, 148); font-style: italic }  
.highlight .cs { color: #546E7A; font-weight: bold }  
.highlight .gd { color: #000000; background-color: #ffdddd }  
.highlight .ge { font-style: italic }  
.highlight .gr { color: #aa0000 }  
.highlight .gh { color: #999999 }  
.highlight .gi { color: #000000; background-color: #ddffdd }  
.highlight .go { color: #888888 }  
.highlight .gp { color: #555555 }  
.highlight .gs { font-weight: bold }  
.highlight .gu { color: #aaaaaa }  
.highlight .gt { color: #aa0000 }  
.highlight .kc { color: #F77669; font-weight: bold }  
.highlight .kd { color: rgba(233, 237, 237, 1); font-weight: bold }  
.highlight .kn { color: #000080; font-weight: bold }  
.highlight .kp { color: #000080; font-weight: bold }  
.highlight .kr { color: #000080; font-weight: bold }  
.highlight .kt { color: rgb(127, 174, 255); }  
.highlight .m { color: #F77669 }  
.highlight .s { color: rgb(195, 232, 141) }  
.highlight .n { color: rgba(233, 237, 237, 1); }  
.highlight .na { color: #FF0000 }  
.highlight .nc { color: rgba(233, 237, 237, 1); }  
.highlight .nt { color: #000080; font-weight: bold }  
.highlight .ow { font-weight: bold }  
.highlight .w { color: #bbbbbb }  
.highlight .mb { color: #0000FF }  
.highlight .mf { color: #0000FF }  
.highlight .mh { color: #0000FF }  
.highlight .mi { color:rgb(247, 118, 105) }  
.highlight .mo { color: #0000FF }  
.highlight .sa { color: #0000FF }  
.highlight .sb { color: #0000FF }  
.highlight .sc { color: #800080 }  
.highlight .dl { color: #0000FF }  
.highlight .sd { color: #0000FF }  
.highlight .s2 { color: #0000FF }  
.highlight .se { color: #0000FF }  
.highlight .sh { color: #0000FF }  
.highlight .si { color: #0000FF }  
.highlight .sx { color: #0000FF }  
.highlight .sr { color: #0000FF }  
.highlight .s1 { color: #0000FF }  
.highlight .ss { color: #0000FF }  
.highlight .il { color: #0000FF }  

</style>
<meta property="og:title" content="Functional Design" />
<meta property="og:description" content="This is a long due post following the talks given recently at Dawscon, CodeMesh, and Scala Toronto about Functional Design (slides are available here).
 Considering the amount of material available today, Software Design is rather intimidating. When it comes to best practices, one can get overwhelmed quickly and end up with no idea about how to tackle a given problem. Indeed, these guidelines can be vague, or too specific, if not contradictory sometime." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://contramap.dev/posts/2021-01-22-functional_design/" />
<meta property="article:published_time" content="2021-02-02T07:00:00-05:00" />
<meta property="article:modified_time" content="2021-02-02T07:00:00-05:00" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Functional Design"/>
<meta name="twitter:description" content="This is a long due post following the talks given recently at Dawscon, CodeMesh, and Scala Toronto about Functional Design (slides are available here).
 Considering the amount of material available today, Software Design is rather intimidating. When it comes to best practices, one can get overwhelmed quickly and end up with no idea about how to tackle a given problem. Indeed, these guidelines can be vague, or too specific, if not contradictory sometime."/>

<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Functional Design",
  "name": "Functional Design",
  "description": "This is a long due post following the talks given recently at Dawscon, CodeMesh, and Scala Toronto about Functional Design (slides are available here).\n Considering the amount of …",
  "keywords": [
    
  ],
  "articleBody": "  This is a long due post following the talks given recently at Dawscon, CodeMesh, and Scala Toronto about Functional Design (slides are available here).\n Considering the amount of material available today, Software Design is rather intimidating. When it comes to best practices, one can get overwhelmed quickly and end up with no idea about how to tackle a given problem. Indeed, these guidelines can be vague, or too specific, if not contradictory sometime.\nThe problem is that it’s impossible to get all these ideas right without properly understanding their essence. Unfortunately, this is something that tends to be forgotten when teaching design. Too often, we tend to overwhelm people with dozens and dozens of guidelines without actually conveying what ties them all together.\nCoding is like having a civilized and gentle conversation with the future reader of the code. It is about expressing concepts in an intelligible way, to ultimately convince the reader about your solution’s correctness. Properly conveying ideas requires these to be organized and structured, so that each of them can be fully understood separately. In some way, this exercise is very similar to what is done when writing a speech or an e-mail.\nThe Path to Abstraction def incByOne(i: Int): Int = ??? scala val x = incByOne(0) x: Int = 1 scala val y = incByOne(x) x: Int = 2 As it seems and according its signature, incByOne is a function responsible for incrementing the Int it is provided with incremented by one. This function could be implemented in different ways, using bitwise operators or simply the + function, but that’s not really relevant here. In fact, all we care about is that incByOne does what it claims to do.\nIn some cases though, incByOne's implementation may matter. Especially if given a specific argument, it ends up producing an unexpected result:\nscala incByOne(-1) java.lang.IllegalArgumentException: KABOOM ... 32 elided incByOne(42) This is the meaning of life! res0: Int = 42 This situation has two consequences. First, it’s no longer possible to call incByOne and be 100% sure about what it will produce without looking at its internals. In other words, incByOne can no longer be reasoned about without opening it up and guessing what will be produced at runtime. Secondly, refactoring capabilities get lost:\nval a = incByOne(10) // prog1 cannot be used in place of prog2 and vice-versa val prog1 = a val prog2 = incByOne(10) As incByOne(10) may produce an unexpected result, we cannot replace it by a and guarantee that once executed, the program will produce the exact same output than before the refactoring.\nBringing sanity back Let’s now compare the two following functions and think about their respective inputs and outputs:\n  Scala 2 Scala 3  def foo(number: Int): Boolean = number == 42 def bar(number: Int): Boolean = { println(\"Checking number\") number == 42 }   def foo(number: Int): Boolean = number == 42 def bar(number: Int): Boolean = println(\"Checking number\") number == 42    According their signature foo and bar both take an Int and produce a Boolean. However, calling bar results also in printing out \"Checking number\" on the console. Note that this extra output is not captured anywhere in bar's signature.\nThis second output is called a side-effect. In practice, a side-effect is created whenever a function:\n requires some input which is not part of its argument list, and/or produces an output which is not captured by its result type.  In other words, a side-effect is produced when a function interacts with its environment other that through its arguments or its returned type. As explained earlier, this has important consequences in terms of refactoring capabilities but not only. Compared to bar and incByOne, functions such as foo have a very interesting property called Local Reasoning.\n Local Reasoning enables a reader to make sense of a function without looking at how it’s implemented.\n This is a key principle in Software Design and is what enables a component to be abstracted over without knowing about its internals. A good analogy for this is language. In common language, we do not need to explain how a car works every time one needs to be mentioned. The word car can actually be used to define/compose more sophisticated concepts (such as a sports car) and express ourselves in a more concise and meaningful way.\nBack to Software Design, it is common to see codebases having reached a level of complexity preventing their maintainers to do any change without risking major breakdowns. The problem is that beyond a certain point, it is impossible to picture how a program behaves at runtime and be 100% confident about its output without relying on proper abstractions. In other words, if we cannot reason about a word/function’s definition, there is no way we can abstract over it to express a higher level concept.\nBack to real world Local Reasoning is a critical concept but there is one issue though. It prevents using exceptions, null values, and any statement in general (println, readLine…) as these all result in some side-effect or output that cannot be captured by a function’s signature.\nHowever, side-effects are a necessary evil. Indeed, these are always needed whether to get some data from the user, load a configuration, access a database or else. So Local Reasoning is pretty cool on paper, but when it comes to real-world use cases, finding a middle ground is required:\n  Scala 2 Scala 3  import scala.io.StdIn.readLine def welcome(): Unit = { val name = readLine() println(\"Hi \" + name + \"!\") }   import scala.io.StdIn.readLine def welcome(): Unit = val name = readLine() println(\"Hi \" + name + \"!\")    As you probably guess, this program contains two side-effects:\n readLine() which performs a read from the console println() which outputs a string on it  Unfortunately, the inputs and the outputs of these functions cannot be captured in any way. This is du to the nature of readLine() and println() which are statements. Statements are units of execution being run for their side-effects only. For this reason, they are eager, non-deterministic (as anything could happen at runtime), and cannot be replaced by the value they produce. There’s not much we can do about this, but there should be a way to delay their execution, and represent them so that they are locally reasonable.\nClassical approach Usually, this kind of problem is solved by introducing a dependency:   Scala 2 Scala 3  trait Console { def putStrLn(s: String): Unit def getStrLn(): String } def program(console: Console): Unit = { val name = console.getStrLn() console.putStrLn(\"Hi \" + name + \"!\") }   trait Console: def putStrLn(s: String): Unit def getStrLn(): String def program(console: Console): Unit = val name = console.getStrLn() console.putStrLn(\"Hi \" + name + \"!\")    This approach makes program a bit safer to use because we have now control over how side-effects are performed, but calling putStrLn or getStrLn() may still result in a side-effect, preventing them to be reasoned about locally. Secondly, this approach is a poor way to manage dependencies in general as these have to be provided up-front. Applied to a more complex program, this strategy may result indeed in a lack of flexibility and in providing an ever growing context any time we need to use program:\n  Scala 2 Scala 3  def complexProgram(module1: Module1, ..., mn: ModuleN): Unit = { val a = foo(module1, ..., mn) val b = bar(module2, ..., mn) fooBar(a, b, module1, module2 ..., mn) }   def complexProgram(module1: Module1, ..., mn: ModuleN): Unit = val a = foo(module1, ..., mn) val b = bar(module2, ..., mn) fooBar(a, b, module1, module2 ..., mn)    From Statements to Values Another approach is to bring these statements back to the world of values:   Scala 2 Scala 3  import scala.io.StdIn.readLine class IO[A](val run: () = A) object IO { def apply[A](run: = A): IO[A] = new IO(() = run) def putStrLn(s: String): IO[Unit] = IO(println(s)) def getStrLn : IO[String] = IO(readLine()) }   import scala.io.StdIn.readLine class IO[A](val run: () = A) object IO: def apply[A](run: = A): IO[A] = new IO(() = run) def putStrLn(s: String): IO[Unit] = IO(println(s)) def getStrLn : IO[String] = IO(readLine())    IO models a lazy instruction (run) which once executed produces an A. This enables the conversion of statements such as println into values, and to delay the resulting side-effects produced during execution. In order to model the previous program, we would however need a way to sequence two IO which can be done using the andThen operator:\n  Scala 2 Scala 3  class IO[A](val run: () = A) { def andThen[B](f: A = IO[B]): IO[B] = IO(f(run()).run()) } // ... import IO._ // description of the program ('the what') val welcome: IO[Unit] = getStrLn.andThen(name = putStrLn(\"Hi \" + name + \"!\") )   class IO[A](val run: () = A): def andThen[B](f: A = IO[B]): IO[B] = IO(f(run()).run()) // ... import IO._ // description of the program ('the what') val welcome: IO[Unit] = getStrLn.andThen(name = putStrLn(\"Hi \" + name + \"!\") )    andThen pipes the result of an IO to a function producing another IO (you may know this combinator as flatMap). Using andThen, we can now express the previous program and substitute welcome by its definition without affecting the program’s final output:\n// prog1 and prog2 are indeed equivalent val prog1 = welcome val prog2 = getStrLn.andThen(name = putStrLn(\"Hi \" + name + \"!\") But welcome is just a value, and cannot do much on its own. It’s a simple data-structure describing what we’d like to do. To materialize this description, we have to call run:\n// execution of the program (the 'how') welcome.run() Whenever run is called, the program performs any side-effect required to produce the final value. This encoding leads to a complete separation of a program’s description (the what) and its execution (the how). As long as run() is not called, we keep the guarantees provided by local reasoning along with its super-powers, and have control over when side-effects are performed.\nThis tells us something about where and when side-effects should be executed. As nothing can be guaranteed beyond the execution of a side-effect, we should design the program so that it’s always the last thing we do. Once we get to that point, we lose Local Reasoning and have reached the edges of the program.\nHexagonal Architecture Let’s take a quick detour and talk about what we mean by edges. As we’ve seen it earlier Local Reasoning gets compromised whenever side-effects comme into play. In order to keep the code locally reasonable, we therefore delay the moment when side effects are executed until they are absolutely needed. This practice has actually been “preached” since a long time ago. In general, a business application can be divided in two main sections:\n The business logic or the core, which is prone to change a lot and the infrastructures relying on it, which are pretty static    The infrastructures (such as a testing, a file or a database layer) all depend on the core and reside therefore at the edges of the program’s architecture, while the core is completely agnostic about how it is used (by leveraging inversion of control). This approach has different names (Hexagonal architecture, Onion architecture, Ports and Adapts) but overall the goal is always the same: Keep what changes the most (the core) independent of what uses it (the infrastructures).\nAs it is more common to modify the business logic of an application than its infrastructures, it is paramount to prevent the core from being polluted with any aspects related to its context of usage or execution. This guarantees that the same business logic can be re-used in multiple contexts (eg: unit testing, integration testing, production, …) without modifying it.\nRevisiting IO Let’s look back at our example. welcome is locally reasonable, but it has a direct dependency on its execution details (represented by run). Ideally, we’d like to invert this dependency so that the business logic described by welcome can be re-used to create programs interacting with different environment such as a console, a web server, or anything else.\nSecondly this approach shows some limits in the testing phase:\n// Using scala-test \"StrLn\" should \"read an input from the console\" in { val actual: IO[String] = ??? actual.run() should be getStrLn.run() // ??? } With the current implementation, two IO cannot be compared without executing their respective side-effects, which brings us back to square one. Let’s see if we can solve this problem using a different encoding:   Scala 2 Scala 3  sealed trait IO[A] { self = def andThen[B](f: A = IO[B]): IO[B] = IO.AndThen(self, f) } object IO { case class PutStrLn(s: String) extends IO[Unit] case object GetStrLn extends IO[String] case class AndThen[A, B]( io: IO[A], f: A = IO[B] ) extends IO[B] def putStrLn(s: String): IO[Unit] = PutStrLn(s) def getStrLn : IO[String] = GetStrLn } // ... val welcome: IO[Unit] = getStrLn.andThen(name = putStrLn(\"Hi \" + name + \"!\") ) // AndThen(GetStrLn, name = PutStrLn(\"Hi \" + name + \"!\"))   enum IO[A]: self = def andThen[B](f: A = IO[B]): IO[B] = AndThen(self, f) case PutStrLn(s: String) extends IO[Unit] case GetStrLn extends IO[String] case AndThen[A, B](io: IO[A], f: A = IO[B]) extends IO[B] object IO: def putStrLn(s: String): IO[Unit] = PutStrLn(s) def getStrLn : IO[String] = GetStrLn // ... val welcome: IO[Unit] = getStrLn.andThen(name = putStrLn(\"Hi \" + name + \"!\") ) // AndThen(GetStrLn, name = PutStrLn(\"Hi \" + name + \"!\"))   \nIn this encoding, each instruction of our API is represented by a pure data-structure. The definition of welcome stays the same, but this time it is represented by a recursive tree structure which can be inspected, traversed and even optimized if needed. Secondly, instead of embedding the evaluation function run into IO, we define it aside:\n  Scala 2 Scala 3  def run[A](program: IO[A]): A = program match { case GetStrLn = scala.io.StdIn.readLine() case PutStrLn(s) = println(s) case AndThen(c, f) = // not stack safe!!  val io = f(run(c)) run(io) }   def run[A](program: IO[A]): A = program match case GetStrLn = scala.io.StdIn.readLine() case PutStrLn(s) = println(s) case AndThen(c, f) = // not stack safe!!  val io = f(run(c)) run(io)    From a testing perspective, this approach provides a solution to the problem described earlier. Indeed, all we require now is an additional test-specific evaluation function:\n  Scala 2 Scala 3  // program'state case class State(inputs: List[String], outputs: List[String] = List.empty) { def popInput(default: String): (State, String) = (copy(inputs = inputs.tail), inputs.headOption.getOrElse(default)) def pushOutput(s: String): (State, Unit) = (copy(outputs = outputs :+ s), ()) } // test-specific evaluation function / interpreter def testRun[A](program: IO[A], state: State): (State, A) = program match { case GetStrLn = state.popInput(\"Inputs exhausted!\") case PutStrLn(s) = state.pushOutput(s) case AndThen(io, f) = // not stack safe!!  val (state0, a) = testRun(io, state) testRun(f(a), state0) }   // program'state case class State(inputs: List[String], outputs: List[String] = List.empty): def popInput(default: String): (State, String) = (copy(inputs = inputs.tail), inputs.headOption.getOrElse(default)) def pushOutput(s: String): (State, Unit) = (copy(outputs = outputs :+ s), ()) // test-specific evaluation function / interpreter def testRun[A](program: IO[A], state: State): (State, A) = program match case GetStrLn = state.popInput(\"Inputs exhausted!\") case PutStrLn(s) = state.pushOutput(s) case AndThen(io, f) = // not stack safe!!  val (state0, a) = testRun(io, state) testRun(f(a), state0)    run and testRun go through each layer of the program provided and perform any side-effect required to produce the final value. Note these implementations are not stack-safe and would blow up with infinite recursive programs. This can be fixed using Trampolining but that will be the topic of another blog post. In any case, thanks to this approach, comparing two IO is now trivial:\nval actual = testRun(welcome, State(List(\"Bob\"))) actual shouldBe (State(List.empty, List(\"Hi Bob!\")), ()) Let’s take some steps back and look at where interpreters fit in the Hexagonal Architecture. Each interpreter is specific to the layer / context where it is used, maintains a direct dependency towards the core, and therefore resides at the edges of the architecture like shown on this diagram:\n  Note that this approach also opens the door for optimization. We could for example write an interpreter which only purpose is to translate some business logic to an optimized evaluation function that maximizes performances at runtime, or one that optimizes the resulting data-structure into something more manageable. Sky is the limit.\nComposition Despite being different, these two encodings happen to have many similarities. Indeed, both approaches model the domain in terms of primitives, constructors and operators. This is something we’ve already covered in a previous post, but it would be awkward not to mention this here. In any case, these building blocks are what enables us to introduce the third principle of Functional Design which is Composition.\nIf we think about it, designing software goes back to create small simple blocks and to combine these using operators to build bigger blocks. This is the essence of Composition. However, this cannot be achieved if we cannot abstract over these blocks. Hence why Local Reasoning and Purity are so critical.\nLocal Reasoning, Purity and Composition are therefore the three fundamentals we should look for when writing Software, as they are what will let an API to be decomposed and recomposed, to introduce new business requirements or to modify existing ones while minimizing complexity.\nTo the infinity and beyond The example we took is rather simple. Let’s add some spice and think about how error recovering could be implemented. In order to achieve this, we would need two additional primitives:\n  Scala 2 Scala 3  sealed trait IO[A] { self = // ...  def fail(th: Throwable): IO[A] = IO.fail(th) def retry(n: Int): IO[A] = IO.Retry(self, n) } object IO { case class Fail[A](th: Throwable) extends IO[A] case class Retry[A](io: IO[A], n: Int) extends IO[A] // ...  def fail[A](th: Throwable) : IO[A] = Fail(th) def retry[A](io: IO[A], n: Int): IO[A] = Retry(io, n) } def run[A](io: IO[A]): Try[A] = io match { // ...  case Fail(th) = Failure(th) case Retry(io, n) = run(io) match { case Success(a) = Success(a) case Failure(th) if n  1 = run(fail(th)) case Failure(th) = run(Retry(io, n - 1)) } }   enum IO[+A]: self = // ...  case Fail(th: Throwable) extends IO[Nothing] case Retry(io: IO[A], n: Int) extends IO[A] object IO: def fail[A](th: Throwable): IO[A] = Fail(th) def retry[A](io: IO[A], n: Int): IO[A] = Retry(io, n) import scala.util.{Try, Success, Failure} import IO._ def run[A](io: IO[A]): Try[A] = io match // ...  case Fail(th) = Failure(th) case Retry(io, n) = run(io) match case Success(a) = Success(a) case Failure(th) if n  1 = run(fail(th)) case Failure(th) = run(Retry(io, n - 1))     Scala 2 Scala 3  With these new building blocks in our tool belt, we can now express more sophisticated program such as this one: ```scala val welcome: IO[Unit] = getStrLn.andThen(login = if(login != \"admin\") fail(new InvalidLoginException()) else putStrLn(\"Hi \" + name + \"!\") ) ```  Note the type of `run`. It returns a `Try[A]` which captures all the outputs `run` can produce. `Try[A]` is referred to as an effect, which in contrast with a _side-effect_ is expected by the caller of `run`. In other words, the difference between an _effect_ and a _side-effect_ is their expected nature. Now let's think about how would we describe the same program using a more classical or imperative approach. We would probably need a for-loop, a try-catch, a bunch of if-blocks, and end up with a program that is 20 lines long with no way to reuse the logic we've just created. **Functional Design** enables us to do exactly that and to express more powerful constructs with minimal changes. ## Costs You may wonder about the complexity of the encoding. Keep in mind that in real-world scenarios, instead of re-inventing the wheel, one would rely on existing libraries such as [ZIO](https://zio.dev/) and [Cats](https://typelevel.org/cats/). These would provide you with all the basic machinery required to express the business logic along with optimized interpreters. Secondly, another common question is the number of allocation required by the description of a program. Indeed, this requires some allocations in order to be created, but this is non relevant as the cost of instantiating a data-structure is negligible compared to how it is used at runtime. In other words, the performances of a program encoded like above mostly depend on how it is executed. The more optimized is the interpreter, the more efficient is the program. From that perspective, libraries such as the ones mentioned earlier are usually comparable to existing solutions available today if not more efficient (Although it always depends on the use-case). ## Wrap-Up As we've seen it, **Local Reasoning** is critical to leverage abstraction in a codebase. However it prevents a program from doing anything meaningful such as writing in a file or getting some data from the console, as these lead to perform **side-effects**. This can be mitigated by delaying the execution of **side-effects** until these are absolutely needed using a **declarative** or **executable** encoding. Finally we talked about **Composition** which ensures a model can always be composed and recomposed to introduce new business requirements easily or modify existing ones. It's important to mention that overall this is not really about the paradigm used to design a program but more about these three fundamentals. Having said that, Functional Programming leads you naturally to adopt them through [Referential Transparency](https://en.wikipedia.org/wiki/Referential_transparency) and [Lazy Evaluation](https://en.wikipedia.org/wiki/Lazy_evaluation) among others. Unfortunately, Functional Programming is usually taught mostly using concepts that may be intimidating, but this does not have to be done like this. By keeping this small subset of concepts in mind, you can quickly ramp up and be productive. ## Where to go next? The Functional Programming course provided by John DeGoes on [Patreon](https://www.patreon.com/jdegoes/posts) is a good place to start, and is where I've learnt a lot regarding the concepts described in this post. Secondly, there is the [Zionomicon](https://www.zionomicon.com/) which is [ZIO](https://zio.dev/)'s bible, and [Essential Effect](https://essentialeffects.dev/) by Adam Rosien, which is more focused on [Cats](https://typelevel.org/cats/). The combination of these two can give you a good picture of how Functional Programming is today done in Scala. I would also recommend [Functional Programming with Scala](https://www.manning.com/books/functional-programming-in-scala) aka the \"Red book\" which is good but a bit rough for new comers. Finally, [F# for fun and profit](https://fsharpforfunandprofit.com/) is also a good resource. It's not Scala but the concepts described are relevant to most of languages, and Scott Wlaschin (its author) is an incredible teacher, who worked among others on integrating [DDD using a Functional approach](https://pragprog.com/titles/swdddf/domain-modeling-made-functional/). ## Thanks I'd like to thank [John De Goes](https://github.com/jdegoes), [Calvin Lee Fernandes](https://www.linkedin.com/in/calvin-lee-fernandes/) along with the Spartan community for its support, help and friendship, and of course, you for reading :)   ",
  "wordCount" : "3743",
  "inLanguage": "en",
  "datePublished": "2021-02-02T07:00:00-05:00",
  "dateModified": "2021-02-02T07:00:00-05:00",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://contramap.dev/posts/2021-01-22-functional_design/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Francis Toth / Contramap",
    "logo": {
      "@type": "ImageObject",
      "url": "https://contramap.dev/favicon.ico"
    }
  }
}
</script>



</head>

<body class=" dark">
<noscript>
    <style type="text/css">
        .theme-toggle,
        .top-link {
            display: none;
        }

    </style>
</noscript>
<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://contramap.dev" accesskey="h" title="Francis Toth / Contramap (Alt + H)">Francis Toth / Contramap</a>
            <span class="logo-switches">
                
            </span>
        </div>
        <ul class="menu" id="menu" onscroll="menu_on_scroll()">
            <li>
                <a href="https://contramap.dev/about/" title="about">
                    <span>about</span>
                </a>
            </li>
            <li>
                <a href="https://contramap.dev/talks/" title="talks">
                    <span>talks</span>
                </a>
            </li>
            <li>
                <a href="https://contramap.dev/cv/" title="resume">
                    <span>resume</span>
                </a>
            </li><li>
                <a style="display: inline;" target="_blank" href="https://twitter.com/francistoth?lang=en">
                    <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" style="height: 20px; width: 30px; fill: currentColor; transition: transform .1s">
                        <path
                            d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-253.927,424.544c135.939,0 210.268,-112.643 210.268,-210.268c0,-3.218 0,-6.437 -0.153,-9.502c14.406,-10.421 26.973,-23.448 36.935,-38.314c-13.18,5.824 -27.433,9.809 -42.452,11.648c15.326,-9.196 26.973,-23.602 32.49,-40.92c-14.252,8.429 -30.038,14.56 -46.896,17.931c-13.487,-14.406 -32.644,-23.295 -53.946,-23.295c-40.767,0 -73.87,33.104 -73.87,73.87c0,5.824 0.613,11.494 1.992,16.858c-61.456,-3.065 -115.862,-32.49 -152.337,-77.241c-6.284,10.881 -9.962,23.601 -9.962,37.088c0,25.594 13.027,48.276 32.95,61.456c-12.107,-0.307 -23.448,-3.678 -33.41,-9.196l0,0.92c0,35.862 25.441,65.594 59.311,72.49c-6.13,1.686 -12.72,2.606 -19.464,2.606c-4.751,0 -9.348,-0.46 -13.946,-1.38c9.349,29.426 36.628,50.728 68.965,51.341c-25.287,19.771 -57.164,31.571 -91.8,31.571c-5.977,0 -11.801,-0.306 -17.625,-1.073c32.337,21.15 71.264,33.41 112.95,33.41Z" />
                    </svg>
                </a>
                <a style="display: inline;" target="_blank" href="https://ca.linkedin.com/in/francistoth/en-us">
                    <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" style="height: 20px; width: 30px; fill: currentColor; transition: transform .1s">
                        <path
                            d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-288.985,423.278l0,-225.717l-75.04,0l0,225.717l75.04,0Zm270.539,0l0,-129.439c0,-69.333 -37.018,-101.586 -86.381,-101.586c-39.804,0 -57.634,21.891 -67.617,37.266l0,-31.958l-75.021,0c0.995,21.181 0,225.717 0,225.717l75.02,0l0,-126.056c0,-6.748 0.486,-13.492 2.474,-18.315c5.414,-13.475 17.767,-27.434 38.494,-27.434c27.135,0 38.007,20.707 38.007,51.037l0,120.768l75.024,0Zm-307.552,-334.556c-25.674,0 -42.448,16.879 -42.448,39.002c0,21.658 16.264,39.002 41.455,39.002l0.484,0c26.165,0 42.452,-17.344 42.452,-39.002c-0.485,-22.092 -16.241,-38.954 -41.943,-39.002Z" />
                    </svg>
                </a>
                <a style="display: inline;" target="_blank" href="https://github.com/FrancisToth">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round", style="height: 20px; width: 30px; fill: currentColor; transition: transform .1s">
                        <path
                            d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22">
                        </path>
                    </svg>
                </a>
            </li>
            
        </ul>
    </nav>
</header>

    <main class="main">

<article class="post-single">
  <header class="post-header">
    <h1 class="post-title">
      Functional Design
    </h1>
    <div class="post-meta">February 2, 2021

    </div>
  </header> 

  <div class="post-content">
<blockquote>
<p> This is a long due post following the talks given recently at <a href="https://youtu.be/OE_rRu7Uv_E">Dawscon</a>, <a href="https://www.youtube.com/watch?v=0sXxQyi0UTA&amp;feature=emb_logo">CodeMesh</a>, and Scala Toronto about Functional Design (slides are available <a href="/talks/">here</a>).</p>
</blockquote>
<p>Considering the amount of material available today, Software Design is rather intimidating. When it comes to best practices, one can get overwhelmed quickly and end up with no idea about how to tackle a given problem. Indeed, these guidelines can be vague, or too specific, if not contradictory sometime.</p>
<p>The problem is that it&rsquo;s impossible to get all these ideas right without properly understanding their essence. Unfortunately, this is something that tends to be forgotten when teaching design. Too often, we tend to overwhelm people with dozens and dozens of guidelines without actually conveying what ties them all together.</p>
<p>Coding is like having a civilized and gentle conversation with the future reader of the code. It is about expressing concepts in an intelligible way, to ultimately convince the reader about your solution&rsquo;s correctness. Properly conveying ideas requires these to be organized and structured, so that each of them can be fully understood separately. In some way, this exercise is very similar to what is done when writing a speech or an e-mail.</p>
<h2 id="the-path-to-abstraction">The Path to Abstraction<a hidden class="anchor" aria-hidden="true" href="#the-path-to-abstraction">#</a></h2>
<div class="highlight"><pre class="chroma"><code class="language-scala" data-lang="scala"><span class="k">def</span> <span class="n">incByOne</span><span class="o">(</span><span class="n">i</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span><span class="k">:</span> <span class="kt">Int</span> <span class="o">=</span> <span class="o">???</span>
</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-scala" data-lang="scala"><span class="n">scala</span><span class="o">&gt;</span> <span class="k">val</span> <span class="n">x</span> <span class="k">=</span> <span class="n">incByOne</span><span class="o">(</span><span class="mi">0</span><span class="o">)</span>
<span class="n">x</span><span class="k">:</span> <span class="kt">Int</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">scala</span><span class="o">&gt;</span> <span class="k">val</span> <span class="n">y</span> <span class="k">=</span> <span class="n">incByOne</span><span class="o">(</span><span class="n">x</span><span class="o">)</span>
<span class="n">x</span><span class="k">:</span> <span class="kt">Int</span> <span class="o">=</span> <span class="mi">2</span>
</code></pre></div><p>As it seems and according its signature, <code>incByOne</code> is a function responsible for incrementing the <code>Int</code> it is provided with incremented by one. This function could be implemented in different ways, using bitwise operators or simply the <code>+</code> function, but that&rsquo;s not really relevant here. In fact, all we care about is that <code>incByOne</code> <strong>does what it claims to do</strong>.</p>
<p>In some cases though, <code>incByOne</code>'s implementation may matter. Especially if given a specific argument, it ends up producing an unexpected result:</p>
<div class="highlight"><pre class="chroma"><code class="language-scala" data-lang="scala"><span class="n">scala</span><span class="o">&gt;</span> <span class="n">incByOne</span><span class="o">(-</span><span class="mi">1</span><span class="o">)</span>
<span class="n">java</span><span class="o">.</span><span class="n">lang</span><span class="o">.</span><span class="nc">IllegalArgumentException</span><span class="k">:</span> <span class="kt">KABOOM</span>
  <span class="o">...</span> <span class="mi">32</span> <span class="n">elided</span>

<span class="n">incByOne</span><span class="o">(</span><span class="mi">42</span><span class="o">)</span>
<span class="nc">This</span> <span class="n">is</span> <span class="n">the</span> <span class="n">meaning</span> <span class="n">of</span> <span class="n">life</span><span class="o">!</span>
<span class="n">res0</span><span class="k">:</span> <span class="kt">Int</span> <span class="o">=</span> <span class="mi">42</span>
</code></pre></div><p>This situation has two consequences. First, it&rsquo;s no longer possible to call <code>incByOne</code> and be 100% sure about what it will produce without looking at its internals. In other words, <code>incByOne</code> can no longer be <strong>reasoned about</strong> without opening it up and guessing what will be produced at runtime. Secondly, refactoring capabilities get lost:</p>
<div class="highlight"><pre class="chroma"><code class="language-scala" data-lang="scala"><span class="k">val</span> <span class="n">a</span> <span class="k">=</span> <span class="n">incByOne</span><span class="o">(</span><span class="mi">10</span><span class="o">)</span>

<span class="c1">// prog1 cannot be used in place of prog2 and vice-versa
</span><span class="c1"></span><span class="k">val</span> <span class="n">prog1</span> <span class="k">=</span> <span class="n">a</span>
<span class="k">val</span> <span class="n">prog2</span> <span class="k">=</span> <span class="n">incByOne</span><span class="o">(</span><span class="mi">10</span><span class="o">)</span>
</code></pre></div><p>As <code>incByOne(10)</code> may produce an unexpected result, we cannot replace it by <code>a</code> and guarantee that once executed, the program will produce <strong>the exact same output</strong> than before the refactoring.</p>
<h2 id="bringing-sanity-back">Bringing sanity back<a hidden class="anchor" aria-hidden="true" href="#bringing-sanity-back">#</a></h2>
<p>Let&rsquo;s now compare the two following functions and think about their respective inputs and outputs:</p>
<p><div>
    <div>
        <button class="btn grey0 tablink white0" onclick="openCity(event,'scala2', this)">Scala 2</button>
        <button class="btn grey0 tablink" onclick="openCity(event,'scala3', this)">Scala 3</button>
    </div>
    
<div id="scala2" class="city">
    <div class="highlight"><pre class="chroma"><code class="language-scala" data-lang="scala"><span class="k">def</span> <span class="n">foo</span><span class="o">(</span><span class="n">number</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span><span class="k">:</span> <span class="kt">Boolean</span> <span class="o">=</span> 
  <span class="n">number</span> <span class="o">==</span> <span class="mi">42</span>

<span class="k">def</span> <span class="n">bar</span><span class="o">(</span><span class="n">number</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span><span class="k">:</span> <span class="kt">Boolean</span> <span class="o">=</span> <span class="o">{</span>
  <span class="n">println</span><span class="o">(</span><span class="s">&#34;Checking number&#34;</span><span class="o">)</span>
  <span class="n">number</span> <span class="o">==</span> <span class="mi">42</span>
<span class="o">}</span>
</code></pre></div>
 </div>
<div id="scala3" class="city" style="display:none">
    <div class="highlight"><pre class="chroma"><code class="language-scala" data-lang="scala"><span class="k">def</span> <span class="n">foo</span><span class="o">(</span><span class="n">number</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span><span class="k">:</span> <span class="kt">Boolean</span> <span class="o">=</span> 
  <span class="n">number</span> <span class="o">==</span> <span class="mi">42</span>

<span class="k">def</span> <span class="n">bar</span><span class="o">(</span><span class="n">number</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span><span class="k">:</span> <span class="kt">Boolean</span> <span class="o">=</span>
  <span class="n">println</span><span class="o">(</span><span class="s">&#34;Checking number&#34;</span><span class="o">)</span>
  <span class="n">number</span> <span class="o">==</span> <span class="mi">42</span>
</code></pre></div>
 </div>

</div>
According their signature <code>foo</code> and <code>bar</code> both take an <code>Int</code> and produce a <code>Boolean</code>. However, calling <code>bar</code> results also in printing out <code>&quot;Checking number&quot;</code> on the console. Note that this extra output is <strong>not captured anywhere</strong> in <code>bar</code>'s signature.</p>
<p>This second output is called a <strong>side-effect</strong>. In practice, a <strong>side-effect</strong> is created whenever a function:</p>
<ul>
<li><strong>requires some input which is not part of its argument list</strong>,</li>
<li>and/or <strong>produces an output which is not captured by its result type</strong>.</li>
</ul>
<p>In other words, a <strong>side-effect</strong> is produced when a function interacts with its environment other that through its arguments or its returned type. As explained earlier, this has important consequences in terms of refactoring capabilities but not only. Compared to <code>bar</code> and <code>incByOne</code>, functions such as <code>foo</code> have a very interesting property called <strong>Local Reasoning</strong>.</p>
<blockquote>
<p><strong>Local Reasoning</strong> enables a reader to make sense of a function without looking at how it&rsquo;s implemented.</p>
</blockquote>
<p>This is a key principle in Software Design and is what enables a component to be abstracted over without knowing about its internals. A good analogy for this is language. In common language, we do not need to explain how a car works every time one needs to be mentioned. The word <em>car</em> can actually be used to define/compose more sophisticated concepts (such as a <em>sports car</em>) and express ourselves in a more concise and meaningful way.</p>
<p>Back to Software Design, it is common to see codebases having reached a level of complexity preventing their maintainers to do any change without risking major breakdowns. The problem is that beyond a certain point, it is impossible to picture how a program behaves at runtime and be 100% confident about its output without relying on proper abstractions. In other words, <strong>if we cannot reason about a word/function&rsquo;s definition, there is no way we can abstract over it to express a higher level concept</strong>.</p>
<h2 id="back-to-real-world">Back to real world<a hidden class="anchor" aria-hidden="true" href="#back-to-real-world">#</a></h2>
<p><strong>Local Reasoning</strong> is a critical concept but there is one issue though. It
prevents using exceptions, null values, and any statement in general (<code>println</code>, <code>readLine</code>&hellip;) as these all result in some side-effect or output that cannot be captured by a function&rsquo;s signature.</p>
<p>However, <strong>side-effects</strong> are a necessary evil. Indeed, these are always needed whether to get some data from the user, load a configuration, access a database or else. So <strong>Local Reasoning</strong> is pretty cool on paper, but when it comes to real-world use cases, finding a middle ground is required:</p>
<p><div>
    <div>
        <button class="btn grey0 tablink white0" onclick="openCity(event,'scala2', this)">Scala 2</button>
        <button class="btn grey0 tablink" onclick="openCity(event,'scala3', this)">Scala 3</button>
    </div>
    
<div id="scala2" class="city">
    <div class="highlight"><pre class="chroma"><code class="language-scala" data-lang="scala"><span class="k">import</span> <span class="nn">scala.io.StdIn.readLine</span>

<span class="k">def</span> <span class="n">welcome</span><span class="o">()</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>
  <span class="k">val</span> <span class="n">name</span> <span class="k">=</span> <span class="n">readLine</span><span class="o">()</span>
  <span class="n">println</span><span class="o">(</span><span class="s">&#34;Hi &#34;</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="s">&#34;!&#34;</span><span class="o">)</span>
<span class="o">}</span>
</code></pre></div>
 </div>
<div id="scala3" class="city" style="display:none">
    <div class="highlight"><pre class="chroma"><code class="language-scala" data-lang="scala"><span class="k">import</span> <span class="nn">scala.io.StdIn.readLine</span>

<span class="k">def</span> <span class="n">welcome</span><span class="o">()</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span>
  <span class="k">val</span> <span class="n">name</span> <span class="k">=</span> <span class="n">readLine</span><span class="o">()</span>
  <span class="n">println</span><span class="o">(</span><span class="s">&#34;Hi &#34;</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="s">&#34;!&#34;</span><span class="o">)</span>
</code></pre></div>
 </div>

</div>
As you probably guess, this program contains two side-effects:</p>
<ul>
<li><code>readLine()</code> which performs a read from the console</li>
<li><code>println()</code> which outputs a string on it</li>
</ul>
<p>Unfortunately, the inputs and the outputs of these functions cannot be captured in any way. This is du to the nature of <code>readLine()</code> and <code>println()</code> which are <strong>statements</strong>. <strong>Statements</strong> are units of execution being run for their side-effects only. For this reason, they are eager, non-deterministic (as anything could happen at runtime), and cannot be replaced by the value they produce. There&rsquo;s not much we can do about this, but there should be a way to delay their execution, and represent them so that they are locally reasonable.</p>
<h2 id="classical-approach">Classical approach<a hidden class="anchor" aria-hidden="true" href="#classical-approach">#</a></h2>
<p>Usually, this kind of problem is solved by introducing a dependency:
<div>
    <div>
        <button class="btn grey0 tablink white0" onclick="openCity(event,'scala2', this)">Scala 2</button>
        <button class="btn grey0 tablink" onclick="openCity(event,'scala3', this)">Scala 3</button>
    </div>
    
<div id="scala2" class="city">
    <div class="highlight"><pre class="chroma"><code class="language-scala" data-lang="scala"><span class="k">trait</span> <span class="nc">Console</span> <span class="o">{</span>
  <span class="k">def</span> <span class="n">putStrLn</span><span class="o">(</span><span class="n">s</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span><span class="k">:</span> <span class="kt">Unit</span>
  <span class="k">def</span> <span class="n">getStrLn</span><span class="o">()</span><span class="k">:</span> <span class="kt">String</span>
<span class="o">}</span>

<span class="k">def</span> <span class="n">program</span><span class="o">(</span><span class="n">console</span><span class="k">:</span> <span class="kt">Console</span><span class="o">)</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>
  <span class="k">val</span> <span class="n">name</span> <span class="k">=</span> <span class="n">console</span><span class="o">.</span><span class="n">getStrLn</span><span class="o">()</span>
  <span class="n">console</span><span class="o">.</span><span class="n">putStrLn</span><span class="o">(</span><span class="s">&#34;Hi &#34;</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="s">&#34;!&#34;</span><span class="o">)</span>
<span class="o">}</span>
</code></pre></div>
 </div>
<div id="scala3" class="city" style="display:none">
    <div class="highlight"><pre class="chroma"><code class="language-scala" data-lang="scala"><span class="k">trait</span> <span class="nc">Console</span><span class="k">:</span>
  <span class="kt">def</span> <span class="kt">putStrLn</span><span class="o">(</span><span class="kt">s:</span> <span class="kt">String</span><span class="o">)</span><span class="kt">:</span> <span class="kt">Unit</span>
  <span class="k">def</span> <span class="n">getStrLn</span><span class="o">()</span><span class="k">:</span> <span class="kt">String</span>

<span class="k">def</span> <span class="n">program</span><span class="o">(</span><span class="n">console</span><span class="k">:</span> <span class="kt">Console</span><span class="o">)</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span>
  <span class="k">val</span> <span class="n">name</span> <span class="k">=</span> <span class="n">console</span><span class="o">.</span><span class="n">getStrLn</span><span class="o">()</span>
  <span class="n">console</span><span class="o">.</span><span class="n">putStrLn</span><span class="o">(</span><span class="s">&#34;Hi &#34;</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="s">&#34;!&#34;</span><span class="o">)</span>
</code></pre></div>
 </div>

</div>
This approach makes <code>program</code> a bit safer to use because we have now control over how side-effects are performed, but calling <code>putStrLn</code> or <code>getStrLn()</code> may still result in a side-effect, preventing them to be reasoned about locally. Secondly, this approach is a poor way to manage dependencies in general as these have to be provided up-front. Applied to a more complex program, this strategy may result indeed in a lack of flexibility and in providing an ever growing context any time we need to use <code>program</code>:</p>
<div>
    <div>
        <button class="btn grey0 tablink white0" onclick="openCity(event,'scala2', this)">Scala 2</button>
        <button class="btn grey0 tablink" onclick="openCity(event,'scala3', this)">Scala 3</button>
    </div>
    
<div id="scala2" class="city">
    <div class="highlight"><pre class="chroma"><code class="language-scala" data-lang="scala"><span class="k">def</span> <span class="n">complexProgram</span><span class="o">(</span><span class="n">module1</span><span class="k">:</span> <span class="kt">Module1</span><span class="o">,</span> <span class="o">...,</span> <span class="n">mn</span><span class="k">:</span> <span class="kt">ModuleN</span><span class="o">)</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>
  <span class="k">val</span> <span class="n">a</span> <span class="k">=</span> <span class="n">foo</span><span class="o">(</span><span class="n">module1</span><span class="o">,</span> <span class="o">...,</span> <span class="n">mn</span><span class="o">)</span>
  <span class="k">val</span> <span class="n">b</span> <span class="k">=</span> <span class="n">bar</span><span class="o">(</span><span class="n">module2</span><span class="o">,</span> <span class="o">...,</span> <span class="n">mn</span><span class="o">)</span>
  <span class="n">fooBar</span><span class="o">(</span><span class="n">a</span><span class="o">,</span> <span class="n">b</span><span class="o">,</span> <span class="n">module1</span><span class="o">,</span> <span class="n">module2</span> <span class="o">...,</span> <span class="n">mn</span><span class="o">)</span>
<span class="o">}</span>
</code></pre></div>
 </div>
<div id="scala3" class="city" style="display:none">
    <div class="highlight"><pre class="chroma"><code class="language-scala" data-lang="scala"><span class="k">def</span> <span class="n">complexProgram</span><span class="o">(</span><span class="n">module1</span><span class="k">:</span> <span class="kt">Module1</span><span class="o">,</span> <span class="o">...,</span> <span class="n">mn</span><span class="k">:</span> <span class="kt">ModuleN</span><span class="o">)</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span>
  <span class="k">val</span> <span class="n">a</span> <span class="k">=</span> <span class="n">foo</span><span class="o">(</span><span class="n">module1</span><span class="o">,</span> <span class="o">...,</span> <span class="n">mn</span><span class="o">)</span>
  <span class="k">val</span> <span class="n">b</span> <span class="k">=</span> <span class="n">bar</span><span class="o">(</span><span class="n">module2</span><span class="o">,</span> <span class="o">...,</span> <span class="n">mn</span><span class="o">)</span>
  <span class="n">fooBar</span><span class="o">(</span><span class="n">a</span><span class="o">,</span> <span class="n">b</span><span class="o">,</span> <span class="n">module1</span><span class="o">,</span> <span class="n">module2</span> <span class="o">...,</span> <span class="n">mn</span><span class="o">)</span>
</code></pre></div>
 </div>

</div>
<h2 id="from-statements-to-values">From Statements to Values<a hidden class="anchor" aria-hidden="true" href="#from-statements-to-values">#</a></h2>
<p>Another approach is to bring these statements back to the world of values:
<div>
    <div>
        <button class="btn grey0 tablink white0" onclick="openCity(event,'scala2', this)">Scala 2</button>
        <button class="btn grey0 tablink" onclick="openCity(event,'scala3', this)">Scala 3</button>
    </div>
    
<div id="scala2" class="city">
    <div class="highlight"><pre class="chroma"><code class="language-scala" data-lang="scala"><span class="k">import</span> <span class="nn">scala.io.StdIn.readLine</span>

<span class="k">class</span> <span class="nc">IO</span><span class="o">[</span><span class="kt">A</span><span class="o">](</span><span class="k">val</span> <span class="n">run</span><span class="k">:</span> <span class="o">()</span> <span class="o">=&gt;</span> <span class="n">A</span><span class="o">)</span>

<span class="k">object</span> <span class="nc">IO</span> <span class="o">{</span>
  <span class="k">def</span> <span class="n">apply</span><span class="o">[</span><span class="kt">A</span><span class="o">](</span><span class="n">run</span><span class="k">:</span> <span class="o">=&gt;</span> <span class="n">A</span><span class="o">)</span><span class="k">:</span> <span class="kt">IO</span><span class="o">[</span><span class="kt">A</span><span class="o">]</span> <span class="k">=</span> 
    <span class="k">new</span> <span class="nc">IO</span><span class="o">(()</span> <span class="k">=&gt;</span> <span class="n">run</span><span class="o">)</span>

  <span class="k">def</span> <span class="n">putStrLn</span><span class="o">(</span><span class="n">s</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span><span class="k">:</span> <span class="kt">IO</span><span class="o">[</span><span class="kt">Unit</span><span class="o">]</span>   <span class="k">=</span> <span class="nc">IO</span><span class="o">(</span><span class="n">println</span><span class="o">(</span><span class="n">s</span><span class="o">))</span>
  <span class="k">def</span> <span class="n">getStrLn</span>           <span class="k">:</span> <span class="kt">IO</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="k">=</span> <span class="nc">IO</span><span class="o">(</span><span class="n">readLine</span><span class="o">())</span>
<span class="o">}</span>
</code></pre></div>
 </div>
<div id="scala3" class="city" style="display:none">
    <div class="highlight"><pre class="chroma"><code class="language-scala" data-lang="scala"><span class="k">import</span> <span class="nn">scala.io.StdIn.readLine</span>

<span class="k">class</span> <span class="nc">IO</span><span class="o">[</span><span class="kt">A</span><span class="o">](</span><span class="k">val</span> <span class="n">run</span><span class="k">:</span> <span class="o">()</span> <span class="o">=&gt;</span> <span class="n">A</span><span class="o">)</span>

<span class="k">object</span> <span class="nc">IO</span><span class="k">:</span>
  <span class="kt">def</span> <span class="kt">apply</span><span class="o">[</span><span class="kt">A</span><span class="o">](</span><span class="n">run</span><span class="k">:</span> <span class="o">=&gt;</span> <span class="n">A</span><span class="o">)</span><span class="k">:</span> <span class="kt">IO</span><span class="o">[</span><span class="kt">A</span><span class="o">]</span> <span class="k">=</span> 
    <span class="k">new</span> <span class="nc">IO</span><span class="o">(()</span> <span class="k">=&gt;</span> <span class="n">run</span><span class="o">)</span>

  <span class="k">def</span> <span class="n">putStrLn</span><span class="o">(</span><span class="n">s</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span><span class="k">:</span> <span class="kt">IO</span><span class="o">[</span><span class="kt">Unit</span><span class="o">]</span>   <span class="k">=</span> <span class="nc">IO</span><span class="o">(</span><span class="n">println</span><span class="o">(</span><span class="n">s</span><span class="o">))</span>
  <span class="k">def</span> <span class="n">getStrLn</span>           <span class="k">:</span> <span class="kt">IO</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="k">=</span> <span class="nc">IO</span><span class="o">(</span><span class="n">readLine</span><span class="o">())</span>
</code></pre></div>
 </div>

</div>
<code>IO</code> models a lazy instruction (<code>run</code>) which once executed produces an <code>A</code>. This enables the conversion of statements such as <code>println</code> into values, and to delay the resulting side-effects produced during execution. In order to model the previous program, we would however need a way to sequence two <code>IO</code> which  can be done using the <code>andThen</code> operator:</p>
<p><div>
    <div>
        <button class="btn grey0 tablink white0" onclick="openCity(event,'scala2', this)">Scala 2</button>
        <button class="btn grey0 tablink" onclick="openCity(event,'scala3', this)">Scala 3</button>
    </div>
    
<div id="scala2" class="city">
    <div class="highlight"><pre class="chroma"><code class="language-scala" data-lang="scala"><span class="k">class</span> <span class="nc">IO</span><span class="o">[</span><span class="kt">A</span><span class="o">](</span><span class="k">val</span> <span class="n">run</span><span class="k">:</span> <span class="o">()</span> <span class="o">=&gt;</span> <span class="n">A</span><span class="o">)</span> <span class="o">{</span>
  <span class="k">def</span> <span class="n">andThen</span><span class="o">[</span><span class="kt">B</span><span class="o">](</span><span class="n">f</span><span class="k">:</span> <span class="kt">A</span> <span class="o">=&gt;</span> <span class="nc">IO</span><span class="o">[</span><span class="kt">B</span><span class="o">])</span><span class="k">:</span> <span class="kt">IO</span><span class="o">[</span><span class="kt">B</span><span class="o">]</span> <span class="k">=</span>
    <span class="nc">IO</span><span class="o">(</span><span class="n">f</span><span class="o">(</span><span class="n">run</span><span class="o">()).</span><span class="n">run</span><span class="o">())</span>
<span class="o">}</span>
<span class="c1">// ...
</span><span class="c1"></span><span class="k">import</span> <span class="nn">IO._</span>

<span class="c1">// description of the program (&#39;the what&#39;)
</span><span class="c1"></span><span class="k">val</span> <span class="n">welcome</span><span class="k">:</span> <span class="kt">IO</span><span class="o">[</span><span class="kt">Unit</span><span class="o">]</span> <span class="k">=</span>
  <span class="n">getStrLn</span><span class="o">.</span><span class="n">andThen</span><span class="o">(</span><span class="n">name</span> <span class="k">=&gt;</span>
    <span class="n">putStrLn</span><span class="o">(</span><span class="s">&#34;Hi &#34;</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="s">&#34;!&#34;</span><span class="o">)</span>
  <span class="o">)</span>
</code></pre></div>
 </div>
<div id="scala3" class="city" style="display:none">
    <div class="highlight"><pre class="chroma"><code class="language-scala" data-lang="scala"><span class="k">class</span> <span class="nc">IO</span><span class="o">[</span><span class="kt">A</span><span class="o">](</span><span class="k">val</span> <span class="n">run</span><span class="k">:</span> <span class="o">()</span> <span class="o">=&gt;</span> <span class="n">A</span><span class="o">)</span><span class="k">:</span>
  <span class="kt">def</span> <span class="kt">andThen</span><span class="o">[</span><span class="kt">B</span><span class="o">](</span><span class="n">f</span><span class="k">:</span> <span class="kt">A</span> <span class="o">=&gt;</span> <span class="nc">IO</span><span class="o">[</span><span class="kt">B</span><span class="o">])</span><span class="k">:</span> <span class="kt">IO</span><span class="o">[</span><span class="kt">B</span><span class="o">]</span> <span class="k">=</span>
    <span class="nc">IO</span><span class="o">(</span><span class="n">f</span><span class="o">(</span><span class="n">run</span><span class="o">()).</span><span class="n">run</span><span class="o">())</span>
<span class="c1">// ...
</span><span class="c1"></span><span class="k">import</span> <span class="nn">IO._</span>

<span class="c1">// description of the program (&#39;the what&#39;)
</span><span class="c1"></span><span class="k">val</span> <span class="n">welcome</span><span class="k">:</span> <span class="kt">IO</span><span class="o">[</span><span class="kt">Unit</span><span class="o">]</span> <span class="k">=</span>
  <span class="n">getStrLn</span><span class="o">.</span><span class="n">andThen</span><span class="o">(</span><span class="n">name</span> <span class="k">=&gt;</span>
    <span class="n">putStrLn</span><span class="o">(</span><span class="s">&#34;Hi &#34;</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="s">&#34;!&#34;</span><span class="o">)</span>
  <span class="o">)</span>
</code></pre></div>
 </div>

</div>
<code>andThen</code> pipes the result of an <code>IO</code> to a function producing another <code>IO</code> (you may know this combinator as <code>flatMap</code>). Using <code>andThen</code>, we can now express the previous program and substitute <code>welcome</code> by its definition without affecting the program&rsquo;s final output:</p>
<div class="highlight"><pre class="chroma"><code class="language-scala" data-lang="scala"><span class="c1">// prog1 and prog2 are indeed equivalent
</span><span class="c1"></span><span class="k">val</span> <span class="n">prog1</span> <span class="k">=</span> <span class="n">welcome</span>
<span class="k">val</span> <span class="n">prog2</span> <span class="k">=</span> <span class="n">getStrLn</span><span class="o">.</span><span class="n">andThen</span><span class="o">(</span><span class="n">name</span> <span class="k">=&gt;</span> <span class="n">putStrLn</span><span class="o">(</span><span class="s">&#34;Hi &#34;</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="s">&#34;!&#34;</span><span class="o">)</span>
</code></pre></div><p>But <code>welcome</code> is just a value, and cannot do much on its own. It&rsquo;s a simple data-structure <strong>describing</strong> what we&rsquo;d like to do. To materialize this description, we have to call <code>run</code>:</p>
<div class="highlight"><pre class="chroma"><code class="language-scala" data-lang="scala"><span class="c1">// execution of the program (the &#39;how&#39;)
</span><span class="c1"></span><span class="n">welcome</span><span class="o">.</span><span class="n">run</span><span class="o">()</span>
</code></pre></div><p>Whenever <code>run</code> is called, the program performs any side-effect required to produce the final value. This encoding leads to a complete separation of a program&rsquo;s description (the <em>what</em>) and its execution (the <em>how</em>). As long as <code>run()</code> is not called, we keep the guarantees provided by local reasoning along with its super-powers, and have control over when side-effects are performed.</p>
<p>This tells us something about where and when side-effects should be executed. As nothing can be guaranteed beyond the execution of a side-effect, we should design the program so that it&rsquo;s always the last thing we do. Once we get to that point, we lose <strong>Local Reasoning</strong> and have reached the <strong>edges</strong> of the program.</p>
<h2 id="hexagonal-architecture">Hexagonal Architecture<a hidden class="anchor" aria-hidden="true" href="#hexagonal-architecture">#</a></h2>
<p>Let&rsquo;s take a quick detour and talk about what we mean by <strong>edges</strong>. As we&rsquo;ve seen it earlier <strong>Local Reasoning</strong> gets compromised whenever side-effects comme into play. In order to keep the code locally reasonable, we therefore delay the moment when side effects are executed until they are absolutely needed. This practice has actually been &ldquo;preached&rdquo; since a long time ago. In general, a business application can be divided in two main sections:</p>
<ul>
<li>The <strong>business logic or the core</strong>, which is prone to change a lot</li>
<li>and the <strong>infrastructures</strong> relying on it, which are pretty static</li>
</ul>
<div style="">
    <img style="display: block; margin: 0 auto; background-color: transparent; width: 50%;" src="/talks_data/20210115_functionaldesign/images/design_3.png" />
</div>
<br/>
<p>The <strong>infrastructures</strong> (such as a testing, a file or a database layer) all depend on the <strong>core</strong> and reside therefore at the edges of the program&rsquo;s architecture, while the core is completely agnostic about how it is used (by leveraging <a href="https://en.wikipedia.org/wiki/Inversion_of_control">inversion of control</a>). This approach has different names (<a href="https://en.wikipedia.org/wiki/Hexagonal_architecture_(software)">Hexagonal architecture</a>, <a href="https://jeffreypalermo.com/2008/07/the-onion-architecture-part-1/">Onion architecture</a>, Ports and Adapts) but overall the goal is always the same: <strong>Keep what changes the most (the core) independent of what uses it (the infrastructures)</strong>.</p>
<p>As it is more common to modify the business logic of an application than its infrastructures, it is paramount to prevent the core from being polluted with any aspects related to its context of usage or execution. This guarantees that the same business logic can be re-used in multiple contexts (eg: unit testing, integration testing, production, &hellip;) without modifying it.</p>
<h2 id="revisiting-io">Revisiting IO<a hidden class="anchor" aria-hidden="true" href="#revisiting-io">#</a></h2>
<p>Let&rsquo;s look back at our example. <code>welcome</code> is locally reasonable, but it  has a direct dependency on its execution details (represented by <code>run</code>). Ideally, we&rsquo;d like to invert this dependency so that the business logic described by <code>welcome</code> can be re-used to create programs interacting with different environment such as a console, a web server, or anything else.</p>
<p>Secondly this approach shows some limits in the testing phase:</p>
<div class="highlight"><pre class="chroma"><code class="language-scala" data-lang="scala"><span class="c1">// Using scala-test
</span><span class="c1"></span><span class="s">&#34;StrLn&#34;</span> <span class="n">should</span> <span class="s">&#34;read an input from the console&#34;</span> <span class="n">in</span> <span class="o">{</span>
  <span class="k">val</span> <span class="n">actual</span><span class="k">:</span> <span class="kt">IO</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="k">=</span> <span class="o">???</span>
  <span class="n">actual</span><span class="o">.</span><span class="n">run</span><span class="o">()</span> <span class="n">should</span> <span class="n">be</span> <span class="n">getStrLn</span><span class="o">.</span><span class="n">run</span><span class="o">()</span> <span class="c1">// ???
</span><span class="c1"></span><span class="o">}</span>
</code></pre></div><p>With the current implementation, two <code>IO</code> cannot be compared without executing their respective side-effects, which brings us back to square one. Let&rsquo;s see if we can solve this problem using a different encoding:
<div>
    <div>
        <button class="btn grey0 tablink white0" onclick="openCity(event,'scala2', this)">Scala 2</button>
        <button class="btn grey0 tablink" onclick="openCity(event,'scala3', this)">Scala 3</button>
    </div>
    
<div id="scala2" class="city">
    <div class="highlight"><pre class="chroma"><code class="language-scala" data-lang="scala"><span class="k">sealed</span> <span class="k">trait</span> <span class="nc">IO</span><span class="o">[</span><span class="kt">A</span><span class="o">]</span> <span class="o">{</span> <span class="n">self</span> <span class="k">=&gt;</span>
  <span class="k">def</span> <span class="n">andThen</span><span class="o">[</span><span class="kt">B</span><span class="o">](</span><span class="n">f</span><span class="k">:</span> <span class="kt">A</span> <span class="o">=&gt;</span> <span class="nc">IO</span><span class="o">[</span><span class="kt">B</span><span class="o">])</span><span class="k">:</span> <span class="kt">IO</span><span class="o">[</span><span class="kt">B</span><span class="o">]</span> <span class="k">=</span>
    <span class="nc">IO</span><span class="o">.</span><span class="nc">AndThen</span><span class="o">(</span><span class="n">self</span><span class="o">,</span> <span class="n">f</span><span class="o">)</span>
<span class="o">}</span>
<span class="k">object</span> <span class="nc">IO</span> <span class="o">{</span>
  <span class="k">case</span> <span class="k">class</span> <span class="nc">PutStrLn</span><span class="o">(</span><span class="n">s</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">IO</span><span class="o">[</span><span class="kt">Unit</span><span class="o">]</span>
  <span class="k">case</span> <span class="k">object</span> <span class="nc">GetStrLn</span>           <span class="k">extends</span> <span class="nc">IO</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span>

  <span class="k">case</span> <span class="k">class</span> <span class="nc">AndThen</span><span class="o">[</span><span class="kt">A</span>, <span class="kt">B</span><span class="o">](</span>
    <span class="n">io</span><span class="k">:</span> <span class="kt">IO</span><span class="o">[</span><span class="kt">A</span><span class="o">],</span> 
    <span class="n">f</span><span class="k">:</span> <span class="kt">A</span> <span class="o">=&gt;</span> <span class="nc">IO</span><span class="o">[</span><span class="kt">B</span><span class="o">]</span>
  <span class="o">)</span> <span class="k">extends</span> <span class="nc">IO</span><span class="o">[</span><span class="kt">B</span><span class="o">]</span>

  <span class="k">def</span> <span class="n">putStrLn</span><span class="o">(</span><span class="n">s</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span><span class="k">:</span> <span class="kt">IO</span><span class="o">[</span><span class="kt">Unit</span><span class="o">]</span>   <span class="k">=</span> <span class="nc">PutStrLn</span><span class="o">(</span><span class="n">s</span><span class="o">)</span>
  <span class="k">def</span> <span class="n">getStrLn</span>           <span class="k">:</span> <span class="kt">IO</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="k">=</span> <span class="nc">GetStrLn</span>
<span class="o">}</span>

<span class="c1">// ...
</span><span class="c1"></span><span class="k">val</span> <span class="n">welcome</span><span class="k">:</span> <span class="kt">IO</span><span class="o">[</span><span class="kt">Unit</span><span class="o">]</span> <span class="k">=</span>
  <span class="n">getStrLn</span><span class="o">.</span><span class="n">andThen</span><span class="o">(</span><span class="n">name</span> <span class="k">=&gt;</span>
    <span class="n">putStrLn</span><span class="o">(</span><span class="s">&#34;Hi &#34;</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="s">&#34;!&#34;</span><span class="o">)</span>
  <span class="o">)</span>
<span class="c1">// AndThen(GetStrLn, name =&gt; PutStrLn(&#34;Hi &#34; + name + &#34;!&#34;))
</span></code></pre></div>
 </div>
<div id="scala3" class="city" style="display:none">
    <div class="highlight"><pre class="chroma"><code class="language-scala" data-lang="scala"><span class="n">enum</span> <span class="nc">IO</span><span class="o">[</span><span class="kt">A</span><span class="o">]</span><span class="k">:</span>
  <span class="kt">self</span> <span class="o">=&gt;</span>

  <span class="k">def</span> <span class="n">andThen</span><span class="o">[</span><span class="kt">B</span><span class="o">](</span><span class="n">f</span><span class="k">:</span> <span class="kt">A</span> <span class="o">=&gt;</span> <span class="nc">IO</span><span class="o">[</span><span class="kt">B</span><span class="o">])</span><span class="k">:</span> <span class="kt">IO</span><span class="o">[</span><span class="kt">B</span><span class="o">]</span> <span class="k">=</span>
    <span class="nc">AndThen</span><span class="o">(</span><span class="n">self</span><span class="o">,</span> <span class="n">f</span><span class="o">)</span>

  <span class="k">case</span> <span class="nc">PutStrLn</span><span class="o">(</span><span class="n">s</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">IO</span><span class="o">[</span><span class="kt">Unit</span><span class="o">]</span>
  <span class="k">case</span> <span class="nc">GetStrLn</span>            <span class="k">extends</span> <span class="nc">IO</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span>
  <span class="k">case</span> <span class="nc">AndThen</span><span class="o">[</span><span class="kt">A</span>, <span class="kt">B</span><span class="o">](</span><span class="n">io</span><span class="k">:</span> <span class="kt">IO</span><span class="o">[</span><span class="kt">A</span><span class="o">],</span> <span class="n">f</span><span class="k">:</span> <span class="kt">A</span> <span class="o">=&gt;</span> <span class="nc">IO</span><span class="o">[</span><span class="kt">B</span><span class="o">])</span> <span class="k">extends</span> <span class="nc">IO</span><span class="o">[</span><span class="kt">B</span><span class="o">]</span>

<span class="k">object</span> <span class="nc">IO</span><span class="k">:</span>
  <span class="kt">def</span> <span class="kt">putStrLn</span><span class="o">(</span><span class="kt">s:</span> <span class="kt">String</span><span class="o">)</span><span class="kt">:</span> <span class="kt">IO</span><span class="o">[</span><span class="kt">Unit</span><span class="o">]</span>   <span class="k">=</span> <span class="nc">PutStrLn</span><span class="o">(</span><span class="n">s</span><span class="o">)</span>
  <span class="k">def</span> <span class="n">getStrLn</span>           <span class="k">:</span> <span class="kt">IO</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="k">=</span> <span class="nc">GetStrLn</span>

<span class="c1">// ...
</span><span class="c1"></span><span class="k">val</span> <span class="n">welcome</span><span class="k">:</span> <span class="kt">IO</span><span class="o">[</span><span class="kt">Unit</span><span class="o">]</span> <span class="k">=</span>
  <span class="n">getStrLn</span><span class="o">.</span><span class="n">andThen</span><span class="o">(</span><span class="n">name</span> <span class="k">=&gt;</span>
    <span class="n">putStrLn</span><span class="o">(</span><span class="s">&#34;Hi &#34;</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="s">&#34;!&#34;</span><span class="o">)</span>
  <span class="o">)</span>
<span class="c1">// AndThen(GetStrLn, name =&gt; PutStrLn(&#34;Hi &#34; + name + &#34;!&#34;))
</span></code></pre></div>
 </div>

</div></p>
<p>In this encoding, each instruction of our API is represented by a pure  data-structure. The definition of <code>welcome</code> stays the same, but this time it is represented by a recursive tree structure which can be inspected, traversed and even optimized if needed. Secondly, instead of embedding the evaluation function <code>run</code> into <code>IO</code>, we define it aside:</p>
<div>
    <div>
        <button class="btn grey0 tablink white0" onclick="openCity(event,'scala2', this)">Scala 2</button>
        <button class="btn grey0 tablink" onclick="openCity(event,'scala3', this)">Scala 3</button>
    </div>
    
<div id="scala2" class="city">
    <div class="highlight"><pre class="chroma"><code class="language-scala" data-lang="scala"><span class="k">def</span> <span class="n">run</span><span class="o">[</span><span class="kt">A</span><span class="o">](</span><span class="n">program</span><span class="k">:</span> <span class="kt">IO</span><span class="o">[</span><span class="kt">A</span><span class="o">])</span><span class="k">:</span> <span class="kt">A</span> <span class="o">=</span> 
  <span class="n">program</span> <span class="k">match</span> <span class="o">{</span>
    <span class="k">case</span> <span class="nc">GetStrLn</span>      <span class="k">=&gt;</span> <span class="n">scala</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="nc">StdIn</span><span class="o">.</span><span class="n">readLine</span><span class="o">()</span>
    <span class="k">case</span> <span class="nc">PutStrLn</span><span class="o">(</span><span class="n">s</span><span class="o">)</span>   <span class="k">=&gt;</span> <span class="n">println</span><span class="o">(</span><span class="n">s</span><span class="o">)</span>
    <span class="k">case</span> <span class="nc">AndThen</span><span class="o">(</span><span class="n">c</span><span class="o">,</span> <span class="n">f</span><span class="o">)</span>   <span class="k">=&gt;</span>
      <span class="c1">// not stack safe!!
</span><span class="c1"></span>      <span class="k">val</span> <span class="n">io</span> <span class="k">=</span> <span class="n">f</span><span class="o">(</span><span class="n">run</span><span class="o">(</span><span class="n">c</span><span class="o">))</span>
      <span class="n">run</span><span class="o">(</span><span class="n">io</span><span class="o">)</span>
  <span class="o">}</span>
</code></pre></div>
 </div>
<div id="scala3" class="city" style="display:none">
    <div class="highlight"><pre class="chroma"><code class="language-scala" data-lang="scala"><span class="k">def</span> <span class="n">run</span><span class="o">[</span><span class="kt">A</span><span class="o">](</span><span class="n">program</span><span class="k">:</span> <span class="kt">IO</span><span class="o">[</span><span class="kt">A</span><span class="o">])</span><span class="k">:</span> <span class="kt">A</span> <span class="o">=</span> 
  <span class="n">program</span> <span class="k">match</span>
    <span class="k">case</span> <span class="nc">GetStrLn</span>      <span class="k">=&gt;</span> <span class="n">scala</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="nc">StdIn</span><span class="o">.</span><span class="n">readLine</span><span class="o">()</span>
    <span class="k">case</span> <span class="nc">PutStrLn</span><span class="o">(</span><span class="n">s</span><span class="o">)</span>   <span class="k">=&gt;</span> <span class="n">println</span><span class="o">(</span><span class="n">s</span><span class="o">)</span>
    <span class="k">case</span> <span class="nc">AndThen</span><span class="o">(</span><span class="n">c</span><span class="o">,</span> <span class="n">f</span><span class="o">)</span>   <span class="k">=&gt;</span>
      <span class="c1">// not stack safe!!
</span><span class="c1"></span>      <span class="k">val</span> <span class="n">io</span> <span class="k">=</span> <span class="n">f</span><span class="o">(</span><span class="n">run</span><span class="o">(</span><span class="n">c</span><span class="o">))</span>
      <span class="n">run</span><span class="o">(</span><span class="n">io</span><span class="o">)</span>
</code></pre></div>
 </div>

</div>
<p>From a testing perspective, this approach provides a solution to the problem described earlier. Indeed, all we require now is an additional test-specific evaluation function:</p>
<div>
    <div>
        <button class="btn grey0 tablink white0" onclick="openCity(event,'scala2', this)">Scala 2</button>
        <button class="btn grey0 tablink" onclick="openCity(event,'scala3', this)">Scala 3</button>
    </div>
    
<div id="scala2" class="city">
    <div class="highlight"><pre class="chroma"><code class="language-scala" data-lang="scala"><span class="c1">// program&#39;state
</span><span class="c1"></span><span class="k">case</span> <span class="k">class</span> <span class="nc">State</span><span class="o">(</span><span class="n">inputs</span><span class="k">:</span> <span class="kt">List</span><span class="o">[</span><span class="kt">String</span><span class="o">],</span> <span class="n">outputs</span><span class="k">:</span> <span class="kt">List</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="k">=</span> <span class="nc">List</span><span class="o">.</span><span class="n">empty</span><span class="o">)</span> <span class="o">{</span>

  <span class="k">def</span> <span class="n">popInput</span><span class="o">(</span><span class="n">default</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span><span class="k">:</span> <span class="o">(</span><span class="kt">State</span><span class="o">,</span> <span class="kt">String</span><span class="o">)</span> <span class="k">=</span> 
    <span class="o">(</span><span class="n">copy</span><span class="o">(</span><span class="n">inputs</span> <span class="k">=</span> <span class="n">inputs</span><span class="o">.</span><span class="n">tail</span><span class="o">),</span> <span class="n">inputs</span><span class="o">.</span><span class="n">headOption</span><span class="o">.</span><span class="n">getOrElse</span><span class="o">(</span><span class="n">default</span><span class="o">))</span>

  <span class="k">def</span> <span class="n">pushOutput</span><span class="o">(</span><span class="n">s</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span><span class="k">:</span> <span class="o">(</span><span class="kt">State</span><span class="o">,</span> <span class="kt">Unit</span><span class="o">)</span> <span class="k">=</span>
    <span class="o">(</span><span class="n">copy</span><span class="o">(</span><span class="n">outputs</span> <span class="k">=</span> <span class="n">outputs</span> <span class="k">:</span><span class="kt">+</span> <span class="kt">s</span><span class="o">),</span> <span class="o">())</span>
<span class="o">}</span>

<span class="c1">// test-specific evaluation function / interpreter
</span><span class="c1"></span><span class="k">def</span> <span class="n">testRun</span><span class="o">[</span><span class="kt">A</span><span class="o">](</span><span class="n">program</span><span class="k">:</span> <span class="kt">IO</span><span class="o">[</span><span class="kt">A</span><span class="o">],</span> <span class="n">state</span><span class="k">:</span> <span class="kt">State</span><span class="o">)</span><span class="k">:</span> <span class="o">(</span><span class="kt">State</span><span class="o">,</span> <span class="kt">A</span><span class="o">)</span> <span class="k">=</span>
  <span class="n">program</span> <span class="k">match</span> <span class="o">{</span>
    <span class="k">case</span> <span class="nc">GetStrLn</span>     <span class="k">=&gt;</span> <span class="n">state</span><span class="o">.</span><span class="n">popInput</span><span class="o">(</span><span class="s">&#34;Inputs exhausted!&#34;</span><span class="o">)</span>
    <span class="k">case</span> <span class="nc">PutStrLn</span><span class="o">(</span><span class="n">s</span><span class="o">)</span>  <span class="k">=&gt;</span> <span class="n">state</span><span class="o">.</span><span class="n">pushOutput</span><span class="o">(</span><span class="n">s</span><span class="o">)</span>
    <span class="k">case</span> <span class="nc">AndThen</span><span class="o">(</span><span class="n">io</span><span class="o">,</span> <span class="n">f</span><span class="o">)</span> <span class="k">=&gt;</span>
      <span class="c1">// not stack safe!!
</span><span class="c1"></span>      <span class="k">val</span> <span class="o">(</span><span class="n">state0</span><span class="o">,</span> <span class="n">a</span><span class="o">)</span> <span class="k">=</span> <span class="n">testRun</span><span class="o">(</span><span class="n">io</span><span class="o">,</span> <span class="n">state</span><span class="o">)</span>
      <span class="n">testRun</span><span class="o">(</span><span class="n">f</span><span class="o">(</span><span class="n">a</span><span class="o">),</span> <span class="n">state0</span><span class="o">)</span>
  <span class="o">}</span>
</code></pre></div>
 </div>
<div id="scala3" class="city" style="display:none">
    <div class="highlight"><pre class="chroma"><code class="language-scala" data-lang="scala"><span class="c1">// program&#39;state
</span><span class="c1"></span><span class="k">case</span> <span class="k">class</span> <span class="nc">State</span><span class="o">(</span><span class="n">inputs</span><span class="k">:</span> <span class="kt">List</span><span class="o">[</span><span class="kt">String</span><span class="o">],</span> <span class="n">outputs</span><span class="k">:</span> <span class="kt">List</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="k">=</span> <span class="nc">List</span><span class="o">.</span><span class="n">empty</span><span class="o">)</span><span class="k">:</span>
  <span class="kt">def</span> <span class="kt">popInput</span><span class="o">(</span><span class="kt">default:</span> <span class="kt">String</span><span class="o">)</span><span class="kt">:</span> <span class="o">(</span><span class="kt">State</span><span class="o">,</span> <span class="kt">String</span><span class="o">)</span> <span class="k">=</span> 
    <span class="o">(</span><span class="n">copy</span><span class="o">(</span><span class="n">inputs</span> <span class="k">=</span> <span class="n">inputs</span><span class="o">.</span><span class="n">tail</span><span class="o">),</span> <span class="n">inputs</span><span class="o">.</span><span class="n">headOption</span><span class="o">.</span><span class="n">getOrElse</span><span class="o">(</span><span class="n">default</span><span class="o">))</span>

  <span class="k">def</span> <span class="n">pushOutput</span><span class="o">(</span><span class="n">s</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span><span class="k">:</span> <span class="o">(</span><span class="kt">State</span><span class="o">,</span> <span class="kt">Unit</span><span class="o">)</span> <span class="k">=</span>
    <span class="o">(</span><span class="n">copy</span><span class="o">(</span><span class="n">outputs</span> <span class="k">=</span> <span class="n">outputs</span> <span class="k">:</span><span class="kt">+</span> <span class="kt">s</span><span class="o">),</span> <span class="o">())</span>

<span class="c1">// test-specific evaluation function / interpreter
</span><span class="c1"></span><span class="k">def</span> <span class="n">testRun</span><span class="o">[</span><span class="kt">A</span><span class="o">](</span><span class="n">program</span><span class="k">:</span> <span class="kt">IO</span><span class="o">[</span><span class="kt">A</span><span class="o">],</span> <span class="n">state</span><span class="k">:</span> <span class="kt">State</span><span class="o">)</span><span class="k">:</span> <span class="o">(</span><span class="kt">State</span><span class="o">,</span> <span class="kt">A</span><span class="o">)</span> <span class="k">=</span>
  <span class="n">program</span> <span class="k">match</span>
    <span class="k">case</span> <span class="nc">GetStrLn</span>     <span class="k">=&gt;</span> <span class="n">state</span><span class="o">.</span><span class="n">popInput</span><span class="o">(</span><span class="s">&#34;Inputs exhausted!&#34;</span><span class="o">)</span>
    <span class="k">case</span> <span class="nc">PutStrLn</span><span class="o">(</span><span class="n">s</span><span class="o">)</span>  <span class="k">=&gt;</span> <span class="n">state</span><span class="o">.</span><span class="n">pushOutput</span><span class="o">(</span><span class="n">s</span><span class="o">)</span>
    <span class="k">case</span> <span class="nc">AndThen</span><span class="o">(</span><span class="n">io</span><span class="o">,</span> <span class="n">f</span><span class="o">)</span> <span class="k">=&gt;</span>
      <span class="c1">// not stack safe!!
</span><span class="c1"></span>      <span class="k">val</span> <span class="o">(</span><span class="n">state0</span><span class="o">,</span> <span class="n">a</span><span class="o">)</span> <span class="k">=</span> <span class="n">testRun</span><span class="o">(</span><span class="n">io</span><span class="o">,</span> <span class="n">state</span><span class="o">)</span>
      <span class="n">testRun</span><span class="o">(</span><span class="n">f</span><span class="o">(</span><span class="n">a</span><span class="o">),</span> <span class="n">state0</span><span class="o">)</span>
</code></pre></div>
 </div>

</div>
<p><code>run</code> and <code>testRun</code> go through each layer of the program provided and perform any side-effect required to produce the final value. Note these implementations are not stack-safe and would blow up with infinite recursive programs. This can be fixed using Trampolining but that will be the topic of another blog post. In any case, thanks to this approach, comparing two <code>IO</code> is now trivial:</p>
<div class="highlight"><pre class="chroma"><code class="language-scala" data-lang="scala"><span class="k">val</span> <span class="n">actual</span>   <span class="k">=</span> <span class="n">testRun</span><span class="o">(</span><span class="n">welcome</span><span class="o">,</span> <span class="nc">State</span><span class="o">(</span><span class="nc">List</span><span class="o">(</span><span class="s">&#34;Bob&#34;</span><span class="o">)))</span>
<span class="n">actual</span> <span class="n">shouldBe</span> <span class="o">(</span><span class="nc">State</span><span class="o">(</span><span class="nc">List</span><span class="o">.</span><span class="n">empty</span><span class="o">,</span> <span class="nc">List</span><span class="o">(</span><span class="s">&#34;Hi Bob!&#34;</span><span class="o">)),</span> <span class="o">())</span>
</code></pre></div><p>Let&rsquo;s take some steps back and look at where interpreters fit in the <strong>Hexagonal Architecture</strong>. Each interpreter is specific to the layer / context where it is used, maintains a direct dependency towards the core, and therefore resides at the edges of the architecture like shown on this diagram:</p>
<div style="">
    <img style="display: block; margin: 0 auto; background-color: transparent; width: 50%;" src="/talks_data/20210115_functionaldesign/images/design_4.png" />
</div>
<br/>
<p>Note that this approach also opens the door for optimization. We could for example write an interpreter which only purpose is to translate some business logic to an optimized evaluation function that maximizes performances at runtime, or one that optimizes the resulting data-structure into something more manageable. Sky is the limit.</p>
<h2 id="composition">Composition<a hidden class="anchor" aria-hidden="true" href="#composition">#</a></h2>
<p>Despite being different, these two encodings happen to have many similarities. Indeed, both approaches model the domain in terms of <strong>primitives</strong>, <strong>constructors</strong> and <strong>operators</strong>. This is something we&rsquo;ve already covered in a <a href="https://francistoth.github.io/2020/09/22/composition.html">previous post</a>, but it would be awkward not to mention this here.  In any case, these building blocks are what enables us to introduce the third principle of <strong>Functional Design</strong> which is <strong>Composition</strong>.</p>
<p>If we think about it, designing software goes back to create small simple blocks and to combine these using operators to build bigger blocks. This is the essence of <strong>Composition</strong>. However, this cannot be achieved if we cannot abstract over these blocks. Hence why <strong>Local Reasoning</strong> and <strong>Purity</strong> are so critical.</p>
<p><strong>Local Reasoning</strong>, <strong>Purity</strong> and <strong>Composition</strong> are therefore the three fundamentals we should look for when writing Software, as they are what will let an API to be decomposed and recomposed, to introduce new business requirements or to modify existing ones while minimizing complexity.</p>
<h2 id="to-the-infinity-and-beyond">To the infinity and beyond<a hidden class="anchor" aria-hidden="true" href="#to-the-infinity-and-beyond">#</a></h2>
<p>The example we took is rather simple. Let&rsquo;s add some spice and think about how error recovering could be implemented. In order to achieve this, we would need two additional primitives:</p>
<div>
    <div>
        <button class="btn grey0 tablink white0" onclick="openCity(event,'scala2', this)">Scala 2</button>
        <button class="btn grey0 tablink" onclick="openCity(event,'scala3', this)">Scala 3</button>
    </div>
    
<div id="scala2" class="city">
    <div class="highlight"><pre class="chroma"><code class="language-scala" data-lang="scala"><span class="k">sealed</span> <span class="k">trait</span> <span class="nc">IO</span><span class="o">[</span><span class="kt">A</span><span class="o">]</span> <span class="o">{</span> <span class="n">self</span> <span class="k">=&gt;</span>
  <span class="c1">// ...
</span><span class="c1"></span>  <span class="k">def</span> <span class="n">fail</span><span class="o">(</span><span class="n">th</span><span class="k">:</span> <span class="kt">Throwable</span><span class="o">)</span><span class="k">:</span> <span class="kt">IO</span><span class="o">[</span><span class="kt">A</span><span class="o">]</span> <span class="k">=</span> <span class="nc">IO</span><span class="o">.</span><span class="n">fail</span><span class="o">(</span><span class="n">th</span><span class="o">)</span>
  <span class="k">def</span> <span class="n">retry</span><span class="o">(</span><span class="n">n</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span><span class="k">:</span> <span class="kt">IO</span><span class="o">[</span><span class="kt">A</span><span class="o">]</span>       <span class="k">=</span> <span class="nc">IO</span><span class="o">.</span><span class="nc">Retry</span><span class="o">(</span><span class="n">self</span><span class="o">,</span> <span class="n">n</span><span class="o">)</span>
<span class="o">}</span>
<span class="k">object</span> <span class="nc">IO</span> <span class="o">{</span>
  <span class="k">case</span> <span class="k">class</span> <span class="nc">Fail</span><span class="o">[</span><span class="kt">A</span><span class="o">](</span><span class="n">th</span><span class="k">:</span> <span class="kt">Throwable</span><span class="o">)</span>      <span class="k">extends</span> <span class="nc">IO</span><span class="o">[</span><span class="kt">A</span><span class="o">]</span>
  <span class="k">case</span> <span class="k">class</span> <span class="nc">Retry</span><span class="o">[</span><span class="kt">A</span><span class="o">](</span><span class="n">io</span><span class="k">:</span> <span class="kt">IO</span><span class="o">[</span><span class="kt">A</span><span class="o">],</span> <span class="n">n</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">IO</span><span class="o">[</span><span class="kt">A</span><span class="o">]</span>
  <span class="c1">// ...
</span><span class="c1"></span>  <span class="k">def</span> <span class="n">fail</span><span class="o">[</span><span class="kt">A</span><span class="o">](</span><span class="n">th</span><span class="k">:</span> <span class="kt">Throwable</span><span class="o">)</span>     <span class="k">:</span> <span class="kt">IO</span><span class="o">[</span><span class="kt">A</span><span class="o">]</span> <span class="k">=</span> <span class="nc">Fail</span><span class="o">(</span><span class="n">th</span><span class="o">)</span>
  <span class="k">def</span> <span class="n">retry</span><span class="o">[</span><span class="kt">A</span><span class="o">](</span><span class="n">io</span><span class="k">:</span> <span class="kt">IO</span><span class="o">[</span><span class="kt">A</span><span class="o">],</span> <span class="n">n</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span><span class="k">:</span> <span class="kt">IO</span><span class="o">[</span><span class="kt">A</span><span class="o">]</span> <span class="k">=</span> <span class="nc">Retry</span><span class="o">(</span><span class="n">io</span><span class="o">,</span> <span class="n">n</span><span class="o">)</span>
<span class="o">}</span>

<span class="k">def</span> <span class="n">run</span><span class="o">[</span><span class="kt">A</span><span class="o">](</span><span class="n">io</span><span class="k">:</span> <span class="kt">IO</span><span class="o">[</span><span class="kt">A</span><span class="o">])</span><span class="k">:</span> <span class="kt">Try</span><span class="o">[</span><span class="kt">A</span><span class="o">]</span> <span class="k">=</span>
  <span class="n">io</span> <span class="k">match</span> <span class="o">{</span>
      <span class="c1">// ...
</span><span class="c1"></span>    <span class="k">case</span> <span class="nc">Fail</span><span class="o">(</span><span class="n">th</span><span class="o">)</span>     <span class="k">=&gt;</span> <span class="nc">Failure</span><span class="o">(</span><span class="n">th</span><span class="o">)</span>
    <span class="k">case</span> <span class="nc">Retry</span><span class="o">(</span><span class="n">io</span><span class="o">,</span> <span class="n">n</span><span class="o">)</span> <span class="k">=&gt;</span>
      <span class="n">run</span><span class="o">(</span><span class="n">io</span><span class="o">)</span> <span class="k">match</span> <span class="o">{</span>
        <span class="k">case</span> <span class="nc">Success</span><span class="o">(</span><span class="n">a</span><span class="o">)</span>            <span class="k">=&gt;</span> <span class="nc">Success</span><span class="o">(</span><span class="n">a</span><span class="o">)</span>
        <span class="k">case</span> <span class="nc">Failure</span><span class="o">(</span><span class="n">th</span><span class="o">)</span> <span class="k">if</span> <span class="n">n</span> <span class="o">&lt;=</span> <span class="mi">1</span> <span class="k">=&gt;</span> <span class="n">run</span><span class="o">(</span><span class="n">fail</span><span class="o">(</span><span class="n">th</span><span class="o">))</span>
        <span class="k">case</span> <span class="nc">Failure</span><span class="o">(</span><span class="n">th</span><span class="o">)</span>           <span class="k">=&gt;</span> <span class="n">run</span><span class="o">(</span><span class="nc">Retry</span><span class="o">(</span><span class="n">io</span><span class="o">,</span> <span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="o">))</span>
      <span class="o">}</span>
  <span class="o">}</span>
</code></pre></div>
 </div>
<div id="scala3" class="city" style="display:none">
    <div class="highlight"><pre class="chroma"><code class="language-scala" data-lang="scala"><span class="n">enum</span> <span class="nc">IO</span><span class="o">[</span><span class="kt">+A</span><span class="o">]</span><span class="k">:</span>
  <span class="kt">self</span> <span class="o">=&gt;</span>
  <span class="c1">// ...
</span><span class="c1"></span>  <span class="k">case</span> <span class="nc">Fail</span><span class="o">(</span><span class="n">th</span><span class="k">:</span> <span class="kt">Throwable</span><span class="o">)</span>      <span class="k">extends</span> <span class="nc">IO</span><span class="o">[</span><span class="kt">Nothing</span><span class="o">]</span>
  <span class="k">case</span> <span class="nc">Retry</span><span class="o">(</span><span class="n">io</span><span class="k">:</span> <span class="kt">IO</span><span class="o">[</span><span class="kt">A</span><span class="o">],</span> <span class="n">n</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">IO</span><span class="o">[</span><span class="kt">A</span><span class="o">]</span>

<span class="k">object</span> <span class="nc">IO</span><span class="k">:</span>
  <span class="kt">def</span> <span class="kt">fail</span><span class="o">[</span><span class="kt">A</span><span class="o">](</span><span class="n">th</span><span class="k">:</span> <span class="kt">Throwable</span><span class="o">)</span><span class="k">:</span> <span class="kt">IO</span><span class="o">[</span><span class="kt">A</span><span class="o">]</span>      <span class="k">=</span> <span class="nc">Fail</span><span class="o">(</span><span class="n">th</span><span class="o">)</span>
  <span class="k">def</span> <span class="n">retry</span><span class="o">[</span><span class="kt">A</span><span class="o">](</span><span class="n">io</span><span class="k">:</span> <span class="kt">IO</span><span class="o">[</span><span class="kt">A</span><span class="o">],</span> <span class="n">n</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span><span class="k">:</span> <span class="kt">IO</span><span class="o">[</span><span class="kt">A</span><span class="o">]</span> <span class="k">=</span>  <span class="nc">Retry</span><span class="o">(</span><span class="n">io</span><span class="o">,</span> <span class="n">n</span><span class="o">)</span>

<span class="k">import</span> <span class="nn">scala.util.</span><span class="o">{</span><span class="nc">Try</span><span class="o">,</span> <span class="nc">Success</span><span class="o">,</span> <span class="nc">Failure</span><span class="o">}</span>
<span class="k">import</span> <span class="nn">IO._</span>
<span class="k">def</span> <span class="n">run</span><span class="o">[</span><span class="kt">A</span><span class="o">](</span><span class="n">io</span><span class="k">:</span> <span class="kt">IO</span><span class="o">[</span><span class="kt">A</span><span class="o">])</span><span class="k">:</span> <span class="kt">Try</span><span class="o">[</span><span class="kt">A</span><span class="o">]</span> <span class="k">=</span>
  <span class="n">io</span> <span class="k">match</span>
      <span class="c1">// ...
</span><span class="c1"></span>    <span class="k">case</span> <span class="nc">Fail</span><span class="o">(</span><span class="n">th</span><span class="o">)</span>     <span class="k">=&gt;</span> <span class="nc">Failure</span><span class="o">(</span><span class="n">th</span><span class="o">)</span>
    <span class="k">case</span> <span class="nc">Retry</span><span class="o">(</span><span class="n">io</span><span class="o">,</span> <span class="n">n</span><span class="o">)</span> <span class="k">=&gt;</span>
      <span class="n">run</span><span class="o">(</span><span class="n">io</span><span class="o">)</span> <span class="k">match</span>
        <span class="k">case</span> <span class="nc">Success</span><span class="o">(</span><span class="n">a</span><span class="o">)</span>            <span class="k">=&gt;</span> <span class="nc">Success</span><span class="o">(</span><span class="n">a</span><span class="o">)</span>
        <span class="k">case</span> <span class="nc">Failure</span><span class="o">(</span><span class="n">th</span><span class="o">)</span> <span class="k">if</span> <span class="n">n</span> <span class="o">&lt;=</span> <span class="mi">1</span> <span class="k">=&gt;</span> <span class="n">run</span><span class="o">(</span><span class="n">fail</span><span class="o">(</span><span class="n">th</span><span class="o">))</span>
        <span class="k">case</span> <span class="nc">Failure</span><span class="o">(</span><span class="n">th</span><span class="o">)</span>           <span class="k">=&gt;</span> <span class="n">run</span><span class="o">(</span><span class="nc">Retry</span><span class="o">(</span><span class="n">io</span><span class="o">,</span> <span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="o">))</span>
</code></pre></div>
 </div>
<div>
    <div>
        <button class="btn grey0 tablink white0" onclick="openCity(event,'scala2', this)">Scala 2</button>
        <button class="btn grey0 tablink" onclick="openCity(event,'scala3', this)">Scala 3</button>
    </div>
    

With these new building blocks in our tool belt, we can now express more sophisticated program such as this one:
```scala
val welcome: IO[Unit] = getStrLn.andThen(login =>
  if(login != "admin")
    fail(new InvalidLoginException())
  else
    putStrLn("Hi " + name + "!")
)
```
> Note the type of `run`. It returns a `Try[A]` which captures all the outputs `run` can produce. `Try[A]` is referred to as an effect, which in contrast with a _side-effect_ is expected by the caller of `run`. In other words, the difference between an _effect_ and a _side-effect_ is their expected nature.

Now let's think about how would we describe the same program using a more classical or imperative approach. We would probably need a for-loop, a try-catch, a bunch of if-blocks, and end up with a program that is 20 lines long with no way to reuse the logic we've just created. **Functional Design** enables us to do exactly that and to express more powerful constructs with minimal changes.

## Costs

You may wonder about the complexity of the encoding. Keep in mind that in real-world scenarios, instead of re-inventing the wheel, one would rely on existing libraries such as [ZIO](https://zio.dev/) and [Cats](https://typelevel.org/cats/). These would provide you with all the basic machinery required to express the business logic along with optimized interpreters.

Secondly, another common question is the number of allocation required by the description of a program. Indeed, this requires some allocations in order to be created, but this is non relevant as the cost of instantiating a data-structure is negligible compared to how it is used at runtime. In other words, the performances of a program encoded like above mostly depend on how it is executed. The more optimized is the interpreter, the more efficient is the program. From that perspective, libraries such as the ones mentioned earlier are usually comparable to existing solutions available today if not more efficient (Although it always depends on the use-case).

## Wrap-Up

As we've seen it, **Local Reasoning** is critical to leverage abstraction in a codebase. However it prevents a program from doing anything meaningful such as writing in a file or getting some data from the console, as these lead to perform **side-effects**. This can be mitigated by delaying the execution of **side-effects** until these are absolutely needed using a **declarative** or **executable** encoding. Finally we talked about **Composition** which ensures a model can always be composed and recomposed to introduce new business requirements easily or modify existing ones.

It's important to mention that overall this is not really about the paradigm used to design a program but more about these three fundamentals. Having said that, Functional Programming leads you naturally to adopt them through [Referential Transparency](https://en.wikipedia.org/wiki/Referential_transparency) and [Lazy Evaluation](https://en.wikipedia.org/wiki/Lazy_evaluation) among others. Unfortunately, Functional Programming is usually taught mostly using concepts that may be intimidating, but this does not have to be done like this. By keeping this small subset of concepts in mind, you can quickly ramp up and be productive.

## Where to go next?

The Functional Programming course provided by John DeGoes on [Patreon](https://www.patreon.com/jdegoes/posts) is a good place to start, and is where I've learnt a lot regarding the concepts described in this post.

Secondly, there is the [Zionomicon](https://www.zionomicon.com/) which is [ZIO](https://zio.dev/)'s bible, and [Essential Effect](https://essentialeffects.dev/) by Adam Rosien, which is more focused on [Cats](https://typelevel.org/cats/). The combination of these two can give you a good picture of how Functional Programming is today done in Scala. I would also recommend [Functional Programming with Scala](https://www.manning.com/books/functional-programming-in-scala) aka the "Red book" which is good but a bit rough for new comers.

Finally, [F# for fun and profit](https://fsharpforfunandprofit.com/) is also a good resource. It's not Scala but the concepts described are relevant to most of languages, and Scott Wlaschin (its author) is an incredible teacher, who worked among others on integrating [DDD using a Functional approach](https://pragprog.com/titles/swdddf/domain-modeling-made-functional/).

## Thanks

I'd like to thank [John De Goes](https://github.com/jdegoes), [Calvin Lee Fernandes](https://www.linkedin.com/in/calvin-lee-fernandes/) along with the Spartan community for its support, help and friendship, and of course, you for reading :)
</div>
</div>

</div>
  <footer class="post-footer">



<div class="share-buttons">
    <a target="_blank" rel="noopener noreferrer" aria-label="share Functional Design on twitter"
        href="https://twitter.com/intent/tweet/?text=Functional%20Design&amp;url=https%3a%2f%2fcontramap.dev%2fposts%2f2021-01-22-functional_design%2f&amp;hashtags=">
        <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve">
            <path
                d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-253.927,424.544c135.939,0 210.268,-112.643 210.268,-210.268c0,-3.218 0,-6.437 -0.153,-9.502c14.406,-10.421 26.973,-23.448 36.935,-38.314c-13.18,5.824 -27.433,9.809 -42.452,11.648c15.326,-9.196 26.973,-23.602 32.49,-40.92c-14.252,8.429 -30.038,14.56 -46.896,17.931c-13.487,-14.406 -32.644,-23.295 -53.946,-23.295c-40.767,0 -73.87,33.104 -73.87,73.87c0,5.824 0.613,11.494 1.992,16.858c-61.456,-3.065 -115.862,-32.49 -152.337,-77.241c-6.284,10.881 -9.962,23.601 -9.962,37.088c0,25.594 13.027,48.276 32.95,61.456c-12.107,-0.307 -23.448,-3.678 -33.41,-9.196l0,0.92c0,35.862 25.441,65.594 59.311,72.49c-6.13,1.686 -12.72,2.606 -19.464,2.606c-4.751,0 -9.348,-0.46 -13.946,-1.38c9.349,29.426 36.628,50.728 68.965,51.341c-25.287,19.771 -57.164,31.571 -91.8,31.571c-5.977,0 -11.801,-0.306 -17.625,-1.073c32.337,21.15 71.264,33.41 112.95,33.41Z" />
        </svg>
    </a>
    <a target="_blank" rel="noopener noreferrer" aria-label="share Functional Design on linkedin"
        href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fcontramap.dev%2fposts%2f2021-01-22-functional_design%2f&amp;title=Functional%20Design&amp;summary=Functional%20Design&amp;source=https%3a%2f%2fcontramap.dev%2fposts%2f2021-01-22-functional_design%2f">
        <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve">
            <path
                d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-288.985,423.278l0,-225.717l-75.04,0l0,225.717l75.04,0Zm270.539,0l0,-129.439c0,-69.333 -37.018,-101.586 -86.381,-101.586c-39.804,0 -57.634,21.891 -67.617,37.266l0,-31.958l-75.021,0c0.995,21.181 0,225.717 0,225.717l75.02,0l0,-126.056c0,-6.748 0.486,-13.492 2.474,-18.315c5.414,-13.475 17.767,-27.434 38.494,-27.434c27.135,0 38.007,20.707 38.007,51.037l0,120.768l75.024,0Zm-307.552,-334.556c-25.674,0 -42.448,16.879 -42.448,39.002c0,21.658 16.264,39.002 41.455,39.002l0.484,0c26.165,0 42.452,-17.344 42.452,-39.002c-0.485,-22.092 -16.241,-38.954 -41.943,-39.002Z" />
        </svg>
    </a>
    <a target="_blank" rel="noopener noreferrer" aria-label="share Functional Design on reddit"
        href="https://reddit.com/submit?url=https%3a%2f%2fcontramap.dev%2fposts%2f2021-01-22-functional_design%2f&title=Functional%20Design">
        <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve">
            <path
                d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-3.446,265.638c0,-22.964 -18.616,-41.58 -41.58,-41.58c-11.211,0 -21.361,4.457 -28.841,11.666c-28.424,-20.508 -67.586,-33.757 -111.204,-35.278l18.941,-89.121l61.884,13.157c0.756,15.734 13.642,28.29 29.56,28.29c16.407,0 29.706,-13.299 29.706,-29.701c0,-16.403 -13.299,-29.702 -29.706,-29.702c-11.666,0 -21.657,6.792 -26.515,16.578l-69.105,-14.69c-1.922,-0.418 -3.939,-0.042 -5.585,1.036c-1.658,1.073 -2.811,2.761 -3.224,4.686l-21.152,99.438c-44.258,1.228 -84.046,14.494 -112.837,35.232c-7.468,-7.164 -17.589,-11.591 -28.757,-11.591c-22.965,0 -41.585,18.616 -41.585,41.58c0,16.896 10.095,31.41 24.568,37.918c-0.639,4.135 -0.99,8.328 -0.99,12.576c0,63.977 74.469,115.836 166.33,115.836c91.861,0 166.334,-51.859 166.334,-115.836c0,-4.218 -0.347,-8.387 -0.977,-12.493c14.564,-6.47 24.735,-21.034 24.735,-38.001Zm-119.474,108.193c-20.27,20.241 -59.115,21.816 -70.534,21.816c-11.428,0 -50.277,-1.575 -70.522,-21.82c-3.007,-3.008 -3.007,-7.882 0,-10.889c3.003,-2.999 7.882,-3.003 10.885,0c12.777,12.781 40.11,17.317 59.637,17.317c19.522,0 46.86,-4.536 59.657,-17.321c3.016,-2.999 7.886,-2.995 10.885,0.008c3.008,3.011 3.003,7.882 -0.008,10.889Zm-5.23,-48.781c-16.373,0 -29.701,-13.324 -29.701,-29.698c0,-16.381 13.328,-29.714 29.701,-29.714c16.378,0 29.706,13.333 29.706,29.714c0,16.374 -13.328,29.698 -29.706,29.698Zm-160.386,-29.702c0,-16.381 13.328,-29.71 29.714,-29.71c16.369,0 29.689,13.329 29.689,29.71c0,16.373 -13.32,29.693 -29.689,29.693c-16.386,0 -29.714,-13.32 -29.714,-29.693Z" />
        </svg>
    </a>
    <a target="_blank" rel="noopener noreferrer" aria-label="share Functional Design on facebook"
        href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fcontramap.dev%2fposts%2f2021-01-22-functional_design%2f">
        <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve">
            <path
                d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-106.468,0l0,-192.915l66.6,0l12.672,-82.621l-79.272,0l0,-53.617c0,-22.603 11.073,-44.636 46.58,-44.636l36.042,0l0,-70.34c0,0 -32.71,-5.582 -63.982,-5.582c-65.288,0 -107.96,39.569 -107.96,111.204l0,62.971l-72.573,0l0,82.621l72.573,0l0,192.915l-191.104,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Z" />
        </svg>
    </a>
    <a target="_blank" rel="noopener noreferrer" aria-label="share Functional Design on whatsapp"
        href="https://api.whatsapp.com/send?text=Functional%20Design%20-%20https%3a%2f%2fcontramap.dev%2fposts%2f2021-01-22-functional_design%2f">
        <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve">
            <path
                d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-58.673,127.703c-33.842,-33.881 -78.847,-52.548 -126.798,-52.568c-98.799,0 -179.21,80.405 -179.249,179.234c-0.013,31.593 8.241,62.428 23.927,89.612l-25.429,92.884l95.021,-24.925c26.181,14.28 55.659,21.807 85.658,21.816l0.074,0c98.789,0 179.206,-80.413 179.247,-179.243c0.018,-47.895 -18.61,-92.93 -52.451,-126.81Zm-126.797,275.782l-0.06,0c-26.734,-0.01 -52.954,-7.193 -75.828,-20.767l-5.441,-3.229l-56.386,14.792l15.05,-54.977l-3.542,-5.637c-14.913,-23.72 -22.791,-51.136 -22.779,-79.287c0.033,-82.142 66.867,-148.971 149.046,-148.971c39.793,0.014 77.199,15.531 105.329,43.692c28.128,28.16 43.609,65.592 43.594,105.4c-0.034,82.149 -66.866,148.983 -148.983,148.984Zm81.721,-111.581c-4.479,-2.242 -26.499,-13.075 -30.604,-14.571c-4.105,-1.495 -7.091,-2.241 -10.077,2.241c-2.986,4.483 -11.569,14.572 -14.182,17.562c-2.612,2.988 -5.225,3.364 -9.703,1.12c-4.479,-2.241 -18.91,-6.97 -36.017,-22.23c-13.314,-11.876 -22.304,-26.542 -24.916,-31.026c-2.612,-4.484 -0.279,-6.908 1.963,-9.14c2.016,-2.007 4.48,-5.232 6.719,-7.847c2.24,-2.615 2.986,-4.484 4.479,-7.472c1.493,-2.99 0.747,-5.604 -0.374,-7.846c-1.119,-2.241 -10.077,-24.288 -13.809,-33.256c-3.635,-8.733 -7.327,-7.55 -10.077,-7.688c-2.609,-0.13 -5.598,-0.158 -8.583,-0.158c-2.986,0 -7.839,1.121 -11.944,5.604c-4.105,4.484 -15.675,15.32 -15.675,37.364c0,22.046 16.048,43.342 18.287,46.332c2.24,2.99 31.582,48.227 76.511,67.627c10.685,4.615 19.028,7.371 25.533,9.434c10.728,3.41 20.492,2.929 28.209,1.775c8.605,-1.285 26.499,-10.833 30.231,-21.295c3.732,-10.464 3.732,-19.431 2.612,-21.298c-1.119,-1.869 -4.105,-2.99 -8.583,-5.232Z" />
        </svg>
    </a>
    <a target="_blank" rel="noopener noreferrer" aria-label="share Functional Design on telegram"
        href="https://telegram.me/share/url?text=Functional%20Design&amp;url=https%3a%2f%2fcontramap.dev%2fposts%2f2021-01-22-functional_design%2f">
        <svg version="1.1" xml:space="preserve" viewBox="2 2 28 28">
            <path
                d="M26.49,29.86H5.5a3.37,3.37,0,0,1-2.47-1,3.35,3.35,0,0,1-1-2.47V5.48A3.36,3.36,0,0,1,3,3,3.37,3.37,0,0,1,5.5,2h21A3.38,3.38,0,0,1,29,3a3.36,3.36,0,0,1,1,2.46V26.37a3.35,3.35,0,0,1-1,2.47A3.38,3.38,0,0,1,26.49,29.86Zm-5.38-6.71a.79.79,0,0,0,.85-.66L24.73,9.24a.55.55,0,0,0-.18-.46.62.62,0,0,0-.41-.17q-.08,0-16.53,6.11a.59.59,0,0,0-.41.59.57.57,0,0,0,.43.52l4,1.24,1.61,4.83a.62.62,0,0,0,.63.43.56.56,0,0,0,.4-.17L16.54,20l4.09,3A.9.9,0,0,0,21.11,23.15ZM13.8,20.71l-1.21-4q8.72-5.55,8.78-5.55c.15,0,.23,0,.23.16a.18.18,0,0,1,0,.06s-2.51,2.3-7.52,6.8Z" />
        </svg>
    </a>
</div>

  </footer>
</article>
    </main><footer class="footer">
    <span>&copy; 2021 <a href="https://contramap.dev">Francis Toth / Contramap</a></span>
    <span>&middot;</span>
    <span>Powered by <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a></span>
    <span>&middot;</span>
    <span>Theme <a href="https://git.io/hugopapermod" rel="noopener" target="_blank">PaperMod</a></span>
</footer>
<button class="top-link" id="top-link" type="button" aria-label="go to top" title="Go to Top (Alt + G)" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6">
        <path d="M12 6H0l6-6z" /></svg>
</button>
<script>
    function openCity(evt, cityName, ref) {
        var i = 0;
        var bar = ref.parentElement;
        var tab = ref.parentElement.parentElement;

        var tabs = tab.getElementsByClassName("city");
        for (i = 0; i < tabs.length; i++) {
            tabs[i].style.display = "none";
            if (tabs[i].id == cityName)
                tabs[i].style.display = "block";
        }

        var tablinks = bar.getElementsByClassName("tablink");
        for (i = 0; i < tabs.length; i++) {
            tablinks[i].className = tablinks[i].className.replace(" white0", "");
        }
        evt.currentTarget.className += " white0";
    }
</script>
<script defer src="https://contramap.dev/assets/js/highlight.min.a6d52a378ec80c84a76c9c84a2d95324a9a8ae6e5cd01eedcd79293af2e59342.js" integrity="sha256-ptUqN47IDISnbJyEotlTJKmorm5c0B7tzXkpOvLlk0I="
    onload="hljs.initHighlightingOnLoad();"></script>
<script>
    window.onload = function () {
        if (localStorage.getItem("menu-scroll-position")) {
            document.getElementById('menu').scrollLeft = localStorage.getItem("menu-scroll-position");
        }
    }
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };
    mybutton.onclick = function () {
        document.body.scrollTop = 0;
        document.documentElement.scrollTop = 0;
        window.location.hash = ''
    }

    function menu_on_scroll() {
        localStorage.setItem("menu-scroll-position", document.getElementById('menu').scrollLeft);
    }

</script>

</body>

</html>
